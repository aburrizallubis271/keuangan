<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexiBudget - Aplikasi Keuangan</title>
    <!-- Include jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* Header */
        .header {
            background: #4361ee;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .logo {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        /* Navigation */
        .nav {
            display: flex;
            flex-wrap: wrap;
            background: #3a0ca3;
            border-bottom: 3px solid #3a0ca3;
        }
        
        .nav-btn {
            flex: 1;
            min-width: 60px;
            padding: 12px 5px;
            background: none;
            border: none;
            color: white;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            text-decoration: none;
            text-align: center;
        }
        
        .nav-btn.active {
            background: rgba(255,255,255,0.1);
            border-bottom-color: white;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .nav-btn .nav-icon {
            font-size: 16px;
            display: block;
            margin-bottom: 2px;
        }
        
        .nav-btn .nav-text {
            font-size: 10px;
        }
        
        /* Pages */
        .page {
            display: none;
            padding: 15px;
            animation: fadeIn 0.3s;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        h2 {
            color: #212529;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        input:focus, select:focus {
            border-color: #4361ee;
            outline: none;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: 0.3s;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: #4361ee;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3a0ca3;
        }
        
        .btn-block {
            width: 100%;
            margin-top: 8px;
        }
        
        .btn-success {
            background: #2ec4b6;
            color: white;
        }
        
        .btn-danger {
            background: #e71d36;
            color: white;
        }
        
        .btn-warning {
            background: #ff9f1c;
            color: white;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .btn-group {
            display: flex;
            gap: 5px;
        }
        
        /* Planning Items */
        .planning-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #4361ee;
        }
        
        .planning-info h4 {
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .planning-amount {
            font-size: 16px;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 4px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #2ec4b6;
            transition: width 0.3s;
        }
        
        .progress-fill.warning {
            background: #ff9f1c;
        }
        
        .progress-fill.danger {
            background: #e71d36;
        }
        
        /* Transaction Items */
        .trans-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }
        
        .trans-item:hover {
            background-color: #f8f9fa;
        }
        
        .trans-amount.income {
            color: #2ec4b6;
            font-weight: bold;
        }
        
        .trans-amount.expense {
            color: #e71d36;
            font-weight: bold;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #6c757d;
            font-size: 14px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 15px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6c757d;
        }
        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
        }
        
        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #2ec4b6, #20a394);
        }
        
        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #e71d36, #c1121f);
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            margin: 8px 0;
        }
        
        .stat-label {
            font-size: 12px;
        }
        
        /* Settings Menu */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .menu-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.3s;
        }
        
        .menu-item:hover {
            background: white;
            border-color: #4361ee;
        }
        
        .menu-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        /* Month Navigation */
        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .month-nav-btn {
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .month-nav-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .current-month {
            font-weight: bold;
            color: #4361ee;
            font-size: 16px;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-btn {
                min-width: 45px;
                padding: 10px 3px;
            }
            
            .nav-btn .nav-icon {
                font-size: 14px;
            }
            
            .nav-btn .nav-text {
                font-size: 8px;
            }
            
            .btn-group {
                flex-direction: column;
                gap: 3px;
            }
            
            .btn-group .btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                max-width: 800px;
            }
        }
        
        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .loading.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4361ee;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4361ee;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* Month Planning Status */
        .month-status {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }
        
        .month-status.current {
            background: #e7f5ff;
            border-left: 4px solid #4361ee;
        }
        
        .month-status.archived {
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
        }
        
        .planning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .month-selector select {
            width: auto;
            min-width: 120px;
        }
        
        /* Transaction Action Buttons */
        .trans-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .trans-actions .btn-sm {
            padding: 2px 6px;
            font-size: 11px;
        }
        
        /* Currency Input */
        .currency-input {
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">üí∞ FlexiBudget</div>
            <div style="font-size: 12px; opacity: 0.9;">Kelola Keuangan Personal</div>
        </div>
        
        <!-- Navigation -->
        <div class="nav">
            <button class="nav-btn active" data-page="dashboard">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">Dashboard</span>
            </button>
            <button class="nav-btn" data-page="planning">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Planning</span>
            </button>
            <button class="nav-btn" data-page="transactions">
                <span class="nav-icon">üí≥</span>
                <span class="nav-text">Transaksi</span>
            </button>
            <button class="nav-btn" data-page="reports">
                <span class="nav-icon">üìà</span>
                <span class="nav-text">Laporan</span>
            </button>
            <a href="usaha.html" class="nav-btn">
                <span class="nav-icon">üè¢</span>
                <span class="nav-text">Usaha</span>
            </a>
            <button class="nav-btn" data-page="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
            </button>
        </div>
        
        <!-- Dashboard -->
        <div class="page active" id="dashboard">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Pemasukan</div>
                    <div class="stat-value" id="totalIncome">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Pengeluaran</div>
                    <div class="stat-value" id="totalExpense">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Saldo</div>
                    <div class="stat-value" id="totalBalance">Rp 0</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Status Bulan Ini</h2>
                <div id="monthStatus">Belum ada transaksi</div>
            </div>
            
            <div class="card">
                <div class="planning-header">
                    <h2>Planning Aktif</h2>
                    <div class="current-month" id="currentMonthYear">Januari 2024</div>
                </div>
                <div id="planningList">
                    <div class="empty-state">Belum ada planning</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Transaksi Terbaru</h2>
                <div id="recentTransactions">
                    <div class="empty-state">Belum ada transaksi</div>
                </div>
            </div>
        </div>
        
        <!-- Planning -->
        <div class="page" id="planning">
            <div class="month-nav">
                <button class="month-nav-btn" id="prevMonthBtn">‚Üê Bulan Sebelumnya</button>
                <div class="current-month" id="planningMonthYear">Januari 2024</div>
                <button class="month-nav-btn" id="nextMonthBtn">Bulan Berikutnya ‚Üí</button>
            </div>
            
            <div class="month-status current" id="planningStatus">
                Planning untuk bulan ini
            </div>
            
            <div class="card">
                <h2>Kelola Planning</h2>
                <button class="btn btn-primary btn-block" id="addPlanningBtn">+ Tambah Planning</button>
                <div id="planningItemsList" style="margin-top: 15px;"></div>
            </div>
            
            <div class="card">
                <h2>Sumber Pemasukan</h2>
                <button class="btn btn-success btn-block" id="addIncomeBtn">+ Tambah Pemasukan</button>
                <div id="incomeSourcesList" style="margin-top: 15px;"></div>
            </div>
        </div>
        
        <!-- Transactions -->
        <div class="page" id="transactions">
            <div class="card">
                <h2 id="transactionFormTitle">Tambah Transaksi</h2>
                <form id="transactionForm">
                    <input type="hidden" id="editingTransactionId">
                    <div class="form-group">
                        <label>Jenis</label>
                        <select id="transType" required>
                            <option value="">Pilih jenis</option>
                            <option value="income">Pemasukan</option>
                            <option value="expense">Pengeluaran</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Planning</label>
                        <select id="transPlanning" required>
                            <option value="">Pilih planning</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Jumlah (Rp)</label>
                        <input type="text" id="transAmount" class="currency-input" required placeholder="Contoh: 800.000">
                        <small id="balanceInfo" style="color: #666; display: none;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label>Keterangan</label>
                        <input type="text" id="transDesc" placeholder="Contoh: Beli bensin, Gaji bulanan">
                    </div>
                    
                    <div class="form-group">
                        <label>Tanggal</label>
                        <input type="date" id="transDate" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block" id="transactionSubmitBtn">Simpan Transaksi</button>
                    <button type="button" class="btn btn-warning btn-block" id="cancelEditBtn" style="display: none; margin-top: 8px;">Batal Edit</button>
                </form>
            </div>
            
            <div class="card">
                <div class="planning-header">
                    <h2>Riwayat Transaksi</h2>
                    <div class="month-selector">
                        <select id="transMonthFilter" style="width: auto; min-width: 100px;">
                            <option value="all">Semua Bulan</option>
                        </select>
                    </div>
                </div>
                <div id="transactionHistory"></div>
            </div>
        </div>
        
        <!-- Reports -->
        <div class="page" id="reports">
            <div class="card">
                <h2>Laporan Bulanan</h2>
                
                <div class="form-group">
                    <label>Pilih Bulan</label>
                    <select id="reportMonth" style="margin-bottom: 10px;">
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Pilih Tahun</label>
                    <select id="reportYear"></select>
                </div>
                
                <div id="monthlyReport">
                    <div class="empty-state">Pilih bulan dan tahun</div>
                </div>
                
                <button class="btn btn-primary btn-block" id="exportMonthlyBtn">
                    üìÑ Download Laporan PDF
                </button>
            </div>
            
            <div class="card">
                <h2>Ringkasan Tahun Ini</h2>
                <div id="yearSummary">
                    <div class="empty-state">Belum ada data</div>
                </div>
            </div>
        </div>
        
        <!-- Settings -->
        <div class="page" id="settings">
            <div class="menu-grid">
                <div class="menu-item" id="backupBtn">
                    <div class="menu-icon">üíæ</div>
                    <div>Backup Data</div>
                </div>
                <div class="menu-item" id="restoreBtn">
                    <div class="menu-icon">üîÑ</div>
                    <div>Restore Data</div>
                </div>
                <div class="menu-item" id="resetBtn">
                    <div class="menu-icon">üóëÔ∏è</div>
                    <div>Reset Data</div>
                </div>
                <div class="menu-item" id="addYearBtn">
                    <div class="menu-icon">üìÖ</div>
                    <div>Tambah Tahun</div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 15px;">
                <h2>Informasi Aplikasi</h2>
                <p><strong>Versi:</strong> 1.2</p>
                <p><strong>Tahun Aktif:</strong> <span id="currentYear">2024</span></p>
                <p><strong>Jumlah Planning:</strong> <span id="planningCount">0</span></p>
                <p><strong>Jumlah Transaksi:</strong> <span id="transactionCount">0</span></p>
                <p><strong>Data Tersimpan:</strong> <span id="dataSize">0 KB</span></p>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="planningModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="planningModalTitle">Tambah Planning</h3>
                <button class="close-btn" id="closePlanningBtn">√ó</button>
            </div>
            <div class="modal-body">
                <form id="planningForm">
                    <input type="hidden" id="editingPlanningId">
                    <div class="form-group">
                        <label>Nama Planning</label>
                        <input type="text" id="planningName" required placeholder="Contoh: Transport, Makan, Tabungan">
                    </div>
                    
                    <div class="form-group">
                        <label>Tipe</label>
                        <select id="planningType" required>
                            <option value="Pengeluaran">Pengeluaran</option>
                            <option value="Tabungan">Tabungan</option>
                            <option value="Investasi">Investasi</option>
                            <option value="Pemasukan">Pemasukan</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Target Bulanan (Rp)</label>
                        <input type="text" id="planningTarget" class="currency-input" required placeholder="500.000">
                    </div>
                    
                    <div class="form-group">
                        <label>Keterangan (opsional)</label>
                        <textarea id="planningDesc" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block" id="planningSubmitBtn">Simpan Planning</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal" id="incomeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tambah Pemasukan</h3>
                <button class="close-btn" id="closeIncomeBtn">√ó</button>
            </div>
            <div class="modal-body">
                <form id="incomeForm">
                    <div class="form-group">
                        <label>Nama Sumber</label>
                        <input type="text" id="incomeName" required placeholder="Contoh: Gaji, Freelance, Bonus">
                    </div>
                    
                    <div class="form-group">
                        <label>Jumlah per Bulan (Rp)</label>
                        <input type="text" id="incomeAmount" class="currency-input" required placeholder="3.000.000">
                    </div>
                    
                    <div class="form-group">
                        <label>Keterangan (opsional)</label>
                        <textarea id="incomeDesc" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-block">Simpan Pemasukan</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // ========== APLIKASI UTAMA ==========
        
        // Data structure dengan support multi-bulan
        let appData = {
            version: "1.2",
            currentYear: new Date().getFullYear(),
            currentMonth: new Date().getMonth(),
            planningTemplates: [], // Template planning untuk semua bulan
            monthlyPlanning: {},   // Planning per bulan
            incomeSources: [],     // Sumber pemasukan tetap
            transactions: []       // Semua transaksi
        };
        
        // Nama bulan
        const monthNames = [
            "Januari", "Februari", "Maret", "April", "Mei", "Juni",
            "Juli", "Agustus", "September", "Oktober", "November", "Desember"
        ];
        
        // ========== FUNGSI UTAMA ==========
        
        // Load data
        function loadData() {
            const saved = localStorage.getItem('flexibudget_advanced');
            if (saved) {
                appData = JSON.parse(saved);
                // Initialize monthlyPlanning jika belum ada
                if (!appData.monthlyPlanning) {
                    appData.monthlyPlanning = {};
                }
                // Initialize planningTemplates jika belum ada
                if (!appData.planningTemplates) {
                    appData.planningTemplates = [];
                }
            }
        }
        
        // Save data
        function saveData() {
            localStorage.setItem('flexibudget_advanced', JSON.stringify(appData));
            updateDisplay();
            updateDataSize();
        }
        
        // Update data size display
        function updateDataSize() {
            const data = localStorage.getItem('flexibudget_advanced');
            const size = data ? (data.length / 1024).toFixed(2) : '0';
            document.getElementById('dataSize').textContent = size + ' KB';
        }
        
        // Get current month key
        function getCurrentMonthKey() {
            return `${appData.currentYear}-${appData.currentMonth}`;
        }
        
        // Get planning for current month
        function getCurrentMonthPlanning() {
            const monthKey = getCurrentMonthKey();
            if (!appData.monthlyPlanning[monthKey]) {
                // Create new month planning from templates
                appData.monthlyPlanning[monthKey] = appData.planningTemplates.map(template => ({
                    id: template.id + '_' + monthKey,
                    templateId: template.id,
                    name: template.name,
                    type: template.type,
                    target: template.target,
                    description: template.description,
                    used: 0,
                    collected: 0
                }));
            }
            return appData.monthlyPlanning[monthKey];
        }
        
        // Get planning for specific month
        function getPlanningForMonth(year, month) {
            const monthKey = `${year}-${month}`;
            if (!appData.monthlyPlanning[monthKey]) {
                // Create from templates
                appData.monthlyPlanning[monthKey] = appData.planningTemplates.map(template => ({
                    id: template.id + '_' + monthKey,
                    templateId: template.id,
                    name: template.name,
                    type: template.type,
                    target: template.target,
                    description: template.description,
                    used: 0,
                    collected: 0
                }));
            }
            return appData.monthlyPlanning[monthKey];
        }
        
        // Calculate totals
        function calculateTotals() {
            const totalIncome = appData.incomeSources.reduce((sum, income) => sum + income.amount, 0) +
                               appData.transactions
                                   .filter(t => t.type === 'income')
                                   .reduce((sum, t) => sum + t.amount, 0);
            
            const totalExpense = appData.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = totalIncome - totalExpense;
            
            return { totalIncome, totalExpense, balance };
        }
        
        // Calculate monthly totals
        function calculateMonthlyTotals(year, month) {
            const monthIncome = appData.incomeSources.reduce((sum, income) => sum + income.amount, 0) +
                               appData.transactions
                                   .filter(t => {
                                       const date = new Date(t.date);
                                       return t.type === 'income' && 
                                              date.getFullYear() === year && 
                                              date.getMonth() === month;
                                   })
                                   .reduce((sum, t) => sum + t.amount, 0);
            
            const monthExpense = appData.transactions
                .filter(t => {
                    const date = new Date(t.date);
                    return t.type === 'expense' && 
                           date.getFullYear() === year && 
                           date.getMonth() === month;
                })
                .reduce((sum, t) => sum + t.amount, 0);
            
            const monthBalance = monthIncome - monthExpense;
            
            return { monthIncome, monthExpense, monthBalance };
        }
        
        // Get remaining balance for planning item
        function getRemainingForPlanning(planningId) {
            const planning = getCurrentMonthPlanning().find(p => p.id === planningId);
            if (!planning) return 0;
            
            if (planning.type === 'Pengeluaran') {
                // Update used amount
                planning.used = appData.transactions
                    .filter(t => t.planningId === planningId && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                return Math.max(0, planning.target - planning.used);
            } else if (planning.type === 'Pemasukan') {
                // Update collected amount
                planning.collected = appData.transactions
                    .filter(t => t.planningId === planningId && t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                return Math.max(0, planning.target - planning.collected);
            }
            return 0;
        }
        
        // Show toast notification
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // Show loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        // Hide loading
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        // Format currency input with dots
        function formatCurrencyInput(value) {
            // Remove all non-digit characters except dot
            let cleanValue = value.replace(/[^\d]/g, '');
            
            // If empty, return empty
            if (cleanValue === '') return '';
            
            // Convert to number and format with dots
            let numberValue = parseInt(cleanValue);
            if (isNaN(numberValue)) return '';
            
            // Format with thousand separators
            return numberValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
        
        // Parse formatted currency to number
        function parseCurrency(formatted) {
            if (!formatted || formatted === '') return 0;
            // Remove all dots and convert to number
            const clean = formatted.toString().replace(/\./g, '');
            return parseInt(clean) || 0;
        }
        
        // Format currency for display
        function formatCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                amount = 0;
            }
            return 'Rp ' + Math.round(amount).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
        
        // Update display
        function updateDisplay() {
            // Update dashboard
            updateDashboard();
            
            // Update counts
            document.getElementById('planningCount').textContent = appData.planningTemplates.length;
            document.getElementById('transactionCount').textContent = appData.transactions.length;
            document.getElementById('currentYear').textContent = appData.currentYear;
            
            // Update current month display
            updateMonthDisplay();
            
            // Update planning select
            updatePlanningSelect();
            
            // Update planning list
            updatePlanningList();
            
            // Update income list
            updateIncomeList();
            
            // Update transaction history
            updateTransactionHistory();
        }
        
        // Update month display
        function updateMonthDisplay() {
            const currentMonth = monthNames[appData.currentMonth];
            document.getElementById('currentMonthYear').textContent = `${currentMonth} ${appData.currentYear}`;
            document.getElementById('planningMonthYear').textContent = `${currentMonth} ${appData.currentYear}`;
            
            // Update planning status
            const planningStatus = document.getElementById('planningStatus');
            const monthKey = getCurrentMonthKey();
            if (appData.monthlyPlanning[monthKey] && appData.monthlyPlanning[monthKey].length > 0) {
                planningStatus.textContent = `Planning untuk ${currentMonth} ${appData.currentYear}`;
                planningStatus.className = 'month-status current';
            } else {
                planningStatus.textContent = `Belum ada planning untuk ${currentMonth}. Planning dari template akan dibuat otomatis.`;
                planningStatus.className = 'month-status archived';
            }
        }
        
        // Update dashboard
        function updateDashboard() {
            const totals = calculateTotals();
            
            // Update display
            document.getElementById('totalIncome').textContent = formatCurrency(totals.totalIncome);
            document.getElementById('totalExpense').textContent = formatCurrency(totals.totalExpense);
            document.getElementById('totalBalance').textContent = formatCurrency(totals.balance);
            
            // Update status
            let statusText = '';
            if (totals.balance > 0) {
                statusText = `‚úÖ Sisa uang ${formatCurrency(totals.balance)}`;
            } else if (totals.balance < 0) {
                statusText = `‚ö†Ô∏è Defisit ${formatCurrency(Math.abs(totals.balance))}`;
            } else {
                statusText = '‚öñÔ∏è Habis pas dengan pengeluaran';
            }
            
            // Add info
            statusText += `<br><small>Pemasukan: ${formatCurrency(totals.totalIncome)} | Pengeluaran: ${formatCurrency(totals.totalExpense)}</small>`;
            document.getElementById('monthStatus').innerHTML = statusText;
            
            // Update recent transactions
            updateRecentTransactions();
            
            // Update planning dashboard list
            updatePlanningDashboardList();
        }
        
        // Update planning select
        function updatePlanningSelect() {
            const select = document.getElementById('transPlanning');
            select.innerHTML = '<option value="">Pilih planning</option>';
            
            getCurrentMonthPlanning().forEach(planning => {
                const option = document.createElement('option');
                option.value = planning.id;
                
                let extraInfo = '';
                if (planning.type === 'Pengeluaran') {
                    const remaining = getRemainingForPlanning(planning.id);
                    const used = planning.used || 0;
                    extraInfo = ` (Sisa: ${formatCurrency(remaining)})`;
                } else if (planning.type === 'Pemasukan') {
                    const collected = planning.collected || 0;
                    extraInfo = ` (Terkumpul: ${formatCurrency(collected)})`;
                }
                
                option.textContent = `${planning.name} - ${planning.type}${extraInfo}`;
                select.appendChild(option);
            });
            
            // Event listener untuk update info
            select.addEventListener('change', function() {
                const planningId = this.value;
                const planning = getCurrentMonthPlanning().find(p => p.id === planningId);
                const balanceInfo = document.getElementById('balanceInfo');
                
                if (planning) {
                    if (planning.type === 'Pengeluaran') {
                        const remaining = getRemainingForPlanning(planningId);
                        const used = planning.used || 0;
                        const percentage = planning.target > 0 ? Math.min(100, used / planning.target * 100) : 0;
                        balanceInfo.innerHTML = `Sisa: ${formatCurrency(remaining)} dari ${formatCurrency(planning.target)} (${percentage.toFixed(1)}% terpakai)`;
                        balanceInfo.style.display = 'block';
                        balanceInfo.style.color = percentage > 80 ? '#e71d36' : percentage > 50 ? '#ff9f1c' : '#2ec4b6';
                    } else if (planning.type === 'Pemasukan') {
                        const collected = planning.collected || 0;
                        const percentage = planning.target > 0 ? Math.min(100, collected / planning.target * 100) : 0;
                        balanceInfo.innerHTML = `Terkumpul: ${formatCurrency(collected)} dari ${formatCurrency(planning.target)} (${percentage.toFixed(1)}%)`;
                        balanceInfo.style.display = 'block';
                        balanceInfo.style.color = '#2ec4b6';
                    } else {
                        balanceInfo.style.display = 'none';
                    }
                } else {
                    balanceInfo.style.display = 'none';
                }
            });
        }
        
        // Update planning list
        function updatePlanningList() {
            const container = document.getElementById('planningItemsList');
            const planningItems = getCurrentMonthPlanning();
            
            if (planningItems.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada planning. Tambah planning untuk memulai.</div>';
                return;
            }
            
            container.innerHTML = '';
            planningItems.forEach(planning => {
                let progressHtml = '';
                let statusText = '';
                
                if (planning.type === 'Pengeluaran') {
                    const remaining = getRemainingForPlanning(planning.id);
                    const used = planning.used || 0;
                    const percentage = planning.target > 0 ? Math.min(100, used / planning.target * 100) : 0;
                    
                    let progressClass = '';
                    if (percentage > 80) progressClass = 'danger';
                    else if (percentage > 50) progressClass = 'warning';
                    
                    progressHtml = `
                        <div class="progress-bar">
                            <div class="progress-fill ${progressClass}" style="width: ${percentage}%"></div>
                        </div>
                        <small>Terpakai: ${formatCurrency(used)} | Sisa: ${formatCurrency(remaining)}</small>
                    `;
                    
                    if (remaining <= 0 && planning.target > 0) {
                        statusText = '<span style="color: #e71d36;">‚ùå Sudah melebihi batas!</span>';
                    }
                } else if (planning.type === 'Pemasukan') {
                    const collected = planning.collected || 0;
                    const percentage = planning.target > 0 ? Math.min(100, collected / planning.target * 100) : 0;
                    
                    progressHtml = `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        <small>Terkumpul: ${formatCurrency(collected)} dari ${formatCurrency(planning.target)}</small>
                    `;
                    
                    if (collected >= planning.target && planning.target > 0) {
                        statusText = '<span style="color: #2ec4b6;">‚úÖ Target tercapai!</span>';
                    }
                }
                
                const div = document.createElement('div');
                div.className = 'planning-item';
                div.innerHTML = `
                    <div class="planning-info">
                        <h4>${planning.name}</h4>
                        <div><strong>${planning.type}</strong> | Target: ${formatCurrency(planning.target)}</div>
                        ${planning.description ? `<small>${planning.description}</small>` : ''}
                        ${progressHtml}
                        ${statusText}
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-warning btn-sm" onclick="editPlanning('${planning.id}')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePlanning('${planning.id}')">Hapus</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Update planning dashboard list
        function updatePlanningDashboardList() {
            const container = document.getElementById('planningList');
            const planningItems = getCurrentMonthPlanning();
            
            if (planningItems.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada planning</div>';
                return;
            }
            
            container.innerHTML = '';
            planningItems.forEach(planning => {
                let planningInfo = '';
                
                if (planning.type === 'Pengeluaran') {
                    const remaining = getRemainingForPlanning(planning.id);
                    const used = planning.used || 0;
                    const percentage = planning.target > 0 ? Math.min(100, used / planning.target * 100) : 0;
                    
                    planningInfo = `
                        <div>Sisa: ${formatCurrency(remaining)} dari ${formatCurrency(planning.target)}</div>
                        <div class="progress-bar">
                            <div class="progress-fill ${percentage > 80 ? 'danger' : percentage > 50 ? 'warning' : ''}" style="width: ${percentage}%"></div>
                        </div>
                    `;
                } else if (planning.type === 'Pemasukan') {
                    const collected = planning.collected || 0;
                    const percentage = planning.target > 0 ? Math.min(100, collected / planning.target * 100) : 0;
                    
                    planningInfo = `
                        <div>Terkumpul: ${formatCurrency(collected)} dari ${formatCurrency(planning.target)}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                    `;
                }
                
                const div = document.createElement('div');
                div.className = 'planning-item';
                div.innerHTML = `
                    <div class="planning-info">
                        <h4>${planning.name}</h4>
                        <div><strong>${planning.type}</strong></div>
                        ${planningInfo}
                    </div>
                    <div class="planning-amount" style="color: ${planning.type === 'Pemasukan' ? '#2ec4b6' : '#e71d36'}">
                        ${formatCurrency(planning.target)}
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Update income list
        function updateIncomeList() {
            const container = document.getElementById('incomeSourcesList');
            
            if (appData.incomeSources.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada sumber pemasukan</div>';
                return;
            }
            
            container.innerHTML = '';
            appData.incomeSources.forEach((source, index) => {
                const div = document.createElement('div');
                div.className = 'planning-item';
                div.innerHTML = `
                    <div class="planning-info">
                        <h4>${source.name}</h4>
                        <div><strong>${formatCurrency(source.amount)}</strong> per bulan</div>
                        ${source.description ? `<small>${source.description}</small>` : ''}
                        <small>Menambah total pemasukan</small>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deleteIncomeSource(${index})">Hapus</button>
                `;
                container.appendChild(div);
            });
        }
        
        // Update transaction history
        function updateTransactionHistory() {
            const container = document.getElementById('transactionHistory');
            const monthFilter = document.getElementById('transMonthFilter');
            
            // Update month filter options
            const uniqueMonths = new Set();
            appData.transactions.forEach(trans => {
                const date = new Date(trans.date);
                uniqueMonths.add(`${date.getFullYear()}-${date.getMonth()}`);
            });
            
            monthFilter.innerHTML = '<option value="all">Semua Bulan</option>';
            Array.from(uniqueMonths).sort().reverse().forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = `${monthNames[parseInt(month)]} ${year}`;
                monthFilter.appendChild(option);
            });
            
            // Filter transactions
            let filteredTrans = [...appData.transactions];
            if (monthFilter.value !== 'all') {
                const [year, month] = monthFilter.value.split('-');
                filteredTrans = appData.transactions.filter(t => {
                    const date = new Date(t.date);
                    return date.getFullYear() === parseInt(year) && 
                           date.getMonth() === parseInt(month);
                });
            }
            
            // Sort by date
            filteredTrans.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredTrans.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada transaksi</div>';
                return;
            }
            
            container.innerHTML = '';
            filteredTrans.forEach(trans => {
                const planning = getCurrentMonthPlanning().find(p => p.id === trans.planningId) || 
                               { name: 'Unknown', type: 'Unknown' };
                
                const div = document.createElement('div');
                div.className = 'trans-item';
                div.innerHTML = `
                    <div>
                        <strong>${planning.name}</strong><br>
                        <small>${trans.description || '-'} ‚Ä¢ ${formatDate(trans.date)}</small>
                        <div class="trans-actions">
                            <button class="btn btn-warning btn-sm" onclick="editTransaction('${trans.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTransaction('${trans.id}')">Hapus</button>
                        </div>
                    </div>
                    <div class="trans-amount ${trans.type}">
                        ${trans.type === 'income' ? '+' : '-'} ${formatCurrency(trans.amount)}
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Update recent transactions
        function updateRecentTransactions() {
            const container = document.getElementById('recentTransactions');
            
            // Get 5 most recent transactions
            const recent = appData.transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada transaksi</div>';
                return;
            }
            
            container.innerHTML = '';
            recent.forEach(trans => {
                const planning = getCurrentMonthPlanning().find(p => p.id === trans.planningId) || 
                               { name: 'Unknown', type: 'Unknown' };
                
                const div = document.createElement('div');
                div.className = 'trans-item';
                div.innerHTML = `
                    <div>
                        <strong>${planning.name}</strong><br>
                        <small>${formatDate(trans.date)}</small>
                    </div>
                    <div class="trans-amount ${trans.type}">
                        ${trans.type === 'income' ? '+' : '-'} ${formatCurrency(trans.amount)}
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Generate PDF report
        async function generatePDFReport(year, month) {
            showLoading();
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const monthName = monthNames[month];
                const pageWidth = doc.internal.pageSize.getWidth();
                
                // Header
                doc.setFontSize(20);
                doc.setTextColor(67, 97, 238);
                doc.text('FlexiBudget - Laporan Keuangan', pageWidth / 2, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text(`Bulan: ${monthName} ${year}`, pageWidth / 2, 30, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Dibuat: ${new Date().toLocaleDateString('id-ID')}`, pageWidth / 2, 37, { align: 'center' });
                
                // Summary
                doc.setFontSize(12);
                doc.setTextColor(67, 97, 238);
                doc.text('Ringkasan', 14, 50);
                
                doc.setDrawColor(67, 97, 238);
                doc.setLineWidth(0.5);
                doc.line(14, 52, pageWidth - 14, 52);
                
                const totals = calculateMonthlyTotals(year, month);
                const planning = getPlanningForMonth(year, month);
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Total Pemasukan: ${formatCurrency(totals.monthIncome)}`, 20, 60);
                doc.text(`Total Pengeluaran: ${formatCurrency(totals.monthExpense)}`, 20, 67);
                doc.text(`Saldo: ${formatCurrency(totals.monthBalance)}`, 20, 74);
                
                // Planning Table
                let yPos = 85;
                doc.setFontSize(12);
                doc.setTextColor(67, 97, 238);
                doc.text('Detail Planning', 14, yPos);
                doc.setDrawColor(67, 97, 238);
                doc.line(14, yPos + 2, pageWidth - 14, yPos + 2);
                
                yPos += 10;
                
                const planningData = planning.map(p => {
                    if (p.type === 'Pengeluaran') {
                        const used = appData.transactions
                            .filter(t => t.planningId === p.id && t.type === 'expense')
                            .reduce((sum, t) => sum + t.amount, 0);
                        const remaining = Math.max(0, p.target - used);
                        const percentage = p.target > 0 ? (used / p.target * 100).toFixed(1) : 0;
                        return [
                            p.name,
                            'Pengeluaran',
                            formatCurrency(p.target),
                            formatCurrency(used),
                            formatCurrency(remaining),
                            `${percentage}%`
                        ];
                    } else {
                        const collected = appData.transactions
                            .filter(t => t.planningId === p.id && t.type === 'income')
                            .reduce((sum, t) => sum + t.amount, 0);
                        const percentage = p.target > 0 ? (collected / p.target * 100).toFixed(1) : 0;
                        return [
                            p.name,
                            'Pemasukan',
                            formatCurrency(p.target),
                            formatCurrency(collected),
                            '-',
                            `${percentage}%`
                        ];
                    }
                });
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Planning', 'Tipe', 'Target', 'Terpakai/Terkumpul', 'Sisa', 'Progress']],
                    body: planningData,
                    theme: 'striped',
                    headStyles: { fillColor: [67, 97, 238] },
                    margin: { left: 14, right: 14 }
                });
                
                // Transactions Table
                yPos = doc.lastAutoTable.finalY + 15;
                doc.setFontSize(12);
                doc.setTextColor(67, 97, 238);
                doc.text('Detail Transaksi', 14, yPos);
                doc.setDrawColor(67, 97, 238);
                doc.line(14, yPos + 2, pageWidth - 14, yPos + 2);
                
                yPos += 10;
                
                const monthTransactions = appData.transactions.filter(t => {
                    const date = new Date(t.date);
                    return date.getFullYear() === year && date.getMonth() === month;
                });
                
                const transData = monthTransactions.map(t => {
                    const planningItem = planning.find(p => p.id === t.planningId);
                    return [
                        formatDate(t.date),
                        planningItem ? planningItem.name : '-',
                        t.description || '-',
                        t.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                        formatCurrency(t.amount)
                    ];
                });
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Tanggal', 'Planning', 'Keterangan', 'Jenis', 'Jumlah']],
                    body: transData,
                    theme: 'striped',
                    headStyles: { fillColor: [67, 97, 238] },
                    margin: { left: 14, right: 14 }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`Halaman ${i} dari ${pageCount}`, pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                }
                
                // Save PDF
                doc.save(`Laporan_${monthName}_${year}.pdf`);
                showToast('Laporan berhasil diunduh!');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('Error membuat laporan PDF');
            } finally {
                hideLoading();
            }
        }
        
        // Edit planning function
        window.editPlanning = function(planningId) {
            const planning = getCurrentMonthPlanning().find(p => p.id === planningId);
            if (!planning) return;
            
            // Find template
            const templateIndex = appData.planningTemplates.findIndex(t => t.id === planning.templateId);
            if (templateIndex === -1) return;
            
            // Fill form with existing data
            document.getElementById('planningModalTitle').textContent = 'Edit Planning';
            document.getElementById('editingPlanningId').value = planning.id;
            document.getElementById('planningName').value = planning.name;
            document.getElementById('planningType').value = planning.type;
            document.getElementById('planningTarget').value = formatCurrencyInput(planning.target.toString());
            document.getElementById('planningDesc').value = planning.description || '';
            document.getElementById('planningSubmitBtn').textContent = 'Update Planning';
            
            // Show modal
            document.getElementById('planningModal').classList.add('active');
        };
        
        // Edit transaction function
        window.editTransaction = function(transactionId) {
            const transaction = appData.transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            // Fill form with existing data
            document.getElementById('transactionFormTitle').textContent = 'Edit Transaksi';
            document.getElementById('editingTransactionId').value = transaction.id;
            document.getElementById('transType').value = transaction.type;
            document.getElementById('transPlanning').value = transaction.planningId;
            document.getElementById('transAmount').value = formatCurrencyInput(transaction.amount.toString());
            document.getElementById('transDesc').value = transaction.description || '';
            document.getElementById('transDate').value = transaction.date;
            document.getElementById('transactionSubmitBtn').textContent = 'Update Transaksi';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            // Update planning select info
            const planning = getCurrentMonthPlanning().find(p => p.id === transaction.planningId);
            if (planning) {
                const balanceInfo = document.getElementById('balanceInfo');
                if (planning.type === 'Pengeluaran') {
                    const remaining = getRemainingForPlanning(planning.id) + transaction.amount; // Add back the transaction amount since we're editing
                    const used = (planning.used || 0) - transaction.amount; // Subtract current transaction
                    const percentage = planning.target > 0 ? Math.min(100, used / planning.target * 100) : 0;
                    balanceInfo.innerHTML = `Sisa: ${formatCurrency(remaining)} dari ${formatCurrency(planning.target)} (${percentage.toFixed(1)}% terpakai)`;
                    balanceInfo.style.display = 'block';
                    balanceInfo.style.color = percentage > 80 ? '#e71d36' : percentage > 50 ? '#ff9f1c' : '#2ec4b6';
                } else if (planning.type === 'Pemasukan') {
                    const collected = (planning.collected || 0) - transaction.amount; // Subtract current transaction
                    const percentage = planning.target > 0 ? Math.min(100, collected / planning.target * 100) : 0;
                    balanceInfo.innerHTML = `Terkumpul: ${formatCurrency(collected)} dari ${formatCurrency(planning.target)} (${percentage.toFixed(1)}%)`;
                    balanceInfo.style.display = 'block';
                    balanceInfo.style.color = '#2ec4b6';
                }
            }
            
            // Scroll to form
            document.getElementById('transactions').scrollIntoView({ behavior: 'smooth' });
            
            // Change to transactions page
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelector('.nav-btn[data-page="transactions"]').classList.add('active');
            document.getElementById('transactions').classList.add('active');
        };
        
        // Delete transaction function
        window.deleteTransaction = function(transactionId) {
            const transaction = appData.transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            const planning = getCurrentMonthPlanning().find(p => p.id === transaction.planningId);
            const planningName = planning ? planning.name : 'Unknown';
            
            if (confirm(`Hapus transaksi "${transaction.description || planningName}" sebesar ${formatCurrency(transaction.amount)}?`)) {
                appData.transactions = appData.transactions.filter(t => t.id !== transactionId);
                saveData();
                showToast('Transaksi berhasil dihapus!');
            }
        };
        
        // ========== EVENT HANDLERS ==========
        
        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            if (btn.getAttribute('data-page')) {
                btn.addEventListener('click', function() {
                    // Remove active from all
                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    document.querySelectorAll('.page').forEach(p => {
                        p.classList.remove('active');
                    });
                    
                    // Add active to clicked
                    this.classList.add('active');
                    const pageId = this.getAttribute('data-page');
                    document.getElementById(pageId).classList.add('active');
                    
                    // Refresh page content
                    if (pageId === 'dashboard') {
                        updateDashboard();
                    } else if (pageId === 'planning') {
                        updatePlanningList();
                        updateIncomeList();
                    } else if (pageId === 'transactions') {
                        updateTransactionHistory();
                        // Reset form jika tidak sedang edit
                        if (!document.getElementById('editingTransactionId').value) {
                            document.getElementById('transactionForm').reset();
                            const today = new Date();
                            document.getElementById('transDate').valueAsDate = today;
                            document.getElementById('transDate').value = today.toISOString().split('T')[0];
                            document.getElementById('balanceInfo').style.display = 'none';
                            document.getElementById('transactionFormTitle').textContent = 'Tambah Transaksi';
                            document.getElementById('transactionSubmitBtn').textContent = 'Simpan Transaksi';
                            document.getElementById('cancelEditBtn').style.display = 'none';
                        }
                    } else if (pageId === 'reports') {
                        updateYearSelect();
                    }
                });
            }
        });
        
        // Month navigation
        document.getElementById('prevMonthBtn').addEventListener('click', function() {
            appData.currentMonth--;
            if (appData.currentMonth < 0) {
                appData.currentMonth = 11;
                appData.currentYear--;
            }
            saveData();
        });
        
        document.getElementById('nextMonthBtn').addEventListener('click', function() {
            appData.currentMonth++;
            if (appData.currentMonth > 11) {
                appData.currentMonth = 0;
                appData.currentYear++;
            }
            saveData();
        });
        
        // Add planning
        document.getElementById('addPlanningBtn').addEventListener('click', function() {
            document.getElementById('planningModalTitle').textContent = 'Tambah Planning';
            document.getElementById('editingPlanningId').value = '';
            document.getElementById('planningForm').reset();
            document.getElementById('planningSubmitBtn').textContent = 'Simpan Planning';
            document.getElementById('planningModal').classList.add('active');
        });
        
        // Close planning modal
        document.getElementById('closePlanningBtn').addEventListener('click', function() {
            document.getElementById('planningModal').classList.remove('active');
        });
        
        // Save or update planning
        document.getElementById('planningForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const planningName = document.getElementById('planningName').value.trim();
            const planningType = document.getElementById('planningType').value;
            const planningTarget = parseCurrency(document.getElementById('planningTarget').value);
            const planningDesc = document.getElementById('planningDesc').value.trim();
            const editingPlanningId = document.getElementById('editingPlanningId').value;
            
            if (planningTarget <= 0) {
                alert('Target harus lebih dari 0!');
                return;
            }
            
            const monthKey = getCurrentMonthKey();
            
            if (editingPlanningId) {
                // Editing existing planning
                const planningIndex = getCurrentMonthPlanning().findIndex(p => p.id === editingPlanningId);
                if (planningIndex !== -1) {
                    // Update monthly planning
                    appData.monthlyPlanning[monthKey][planningIndex].name = planningName;
                    appData.monthlyPlanning[monthKey][planningIndex].type = planningType;
                    appData.monthlyPlanning[monthKey][planningIndex].target = planningTarget;
                    appData.monthlyPlanning[monthKey][planningIndex].description = planningDesc;
                    
                    // Update template
                    const templateId = appData.monthlyPlanning[monthKey][planningIndex].templateId;
                    const templateIndex = appData.planningTemplates.findIndex(t => t.id === templateId);
                    if (templateIndex !== -1) {
                        appData.planningTemplates[templateIndex].name = planningName;
                        appData.planningTemplates[templateIndex].type = planningType;
                        appData.planningTemplates[templateIndex].target = planningTarget;
                        appData.planningTemplates[templateIndex].description = planningDesc;
                    }
                    
                    showToast(`Planning "${planningName}" berhasil diperbarui!`);
                }
            } else {
                // Adding new planning
                const template = {
                    id: 'template_' + Date.now(),
                    name: planningName,
                    type: planningType,
                    target: planningTarget,
                    description: planningDesc
                };
                
                appData.planningTemplates.push(template);
                
                // Update current month planning
                const monthlyPlanning = {
                    id: template.id + '_' + monthKey,
                    templateId: template.id,
                    name: planningName,
                    type: planningType,
                    target: planningTarget,
                    description: planningDesc,
                    used: 0,
                    collected: 0
                };
                
                if (!appData.monthlyPlanning[monthKey]) {
                    appData.monthlyPlanning[monthKey] = [];
                }
                appData.monthlyPlanning[monthKey].push(monthlyPlanning);
                
                showToast(`Planning "${planningName}" berhasil ditambahkan!`);
            }
            
            saveData();
            
            // Reset form and close modal
            this.reset();
            document.getElementById('planningModal').classList.remove('active');
        });
        
        // Add income
        document.getElementById('addIncomeBtn').addEventListener('click', function() {
            document.getElementById('incomeModal').classList.add('active');
        });
        
        // Close income modal
        document.getElementById('closeIncomeBtn').addEventListener('click', function() {
            document.getElementById('incomeModal').classList.remove('active');
        });
        
        // Save income
        document.getElementById('incomeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const incomeName = document.getElementById('incomeName').value.trim();
            const incomeAmount = parseCurrency(document.getElementById('incomeAmount').value);
            const incomeDesc = document.getElementById('incomeDesc').value.trim();
            
            if (incomeAmount <= 0) {
                alert('Jumlah pemasukan harus lebih dari 0!');
                return;
            }
            
            const income = {
                id: 'income_' + Date.now(),
                name: incomeName,
                amount: incomeAmount,
                description: incomeDesc
            };
            
            appData.incomeSources.push(income);
            saveData();
            
            // Reset form and close modal
            this.reset();
            document.getElementById('incomeModal').classList.remove('active');
            
            showToast(`Sumber pemasukan "${incomeName}" berhasil ditambahkan!`);
        });
        
        // Currency input formatting for transaction amount
        document.getElementById('transAmount').addEventListener('input', function(e) {
            this.value = formatCurrencyInput(this.value);
        });
        
        // Currency input formatting for planning target
        document.getElementById('planningTarget').addEventListener('input', function(e) {
            this.value = formatCurrencyInput(this.value);
        });
        
        // Currency input formatting for income amount
        document.getElementById('incomeAmount').addEventListener('input', function(e) {
            this.value = formatCurrencyInput(this.value);
        });
        
        // Save or update transaction
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = parseCurrency(document.getElementById('transAmount').value);
            const type = document.getElementById('transType').value;
            const planningId = document.getElementById('transPlanning').value;
            const transDate = document.getElementById('transDate').value;
            const description = document.getElementById('transDesc').value.trim();
            const editingTransactionId = document.getElementById('editingTransactionId').value;
            
            if (!planningId) {
                alert('Pilih planning terlebih dahulu!');
                return;
            }
            
            if (amount <= 0) {
                alert('Jumlah harus lebih dari 0!');
                return;
            }
            
            // Validasi tanggal (tidak boleh di masa depan)
            const today = new Date();
            const selectedDate = new Date(transDate);
            if (selectedDate > today) {
                if (!confirm('Tanggal transaksi di masa depan. Lanjutkan?')) {
                    return;
                }
            }
            
            const planning = getCurrentMonthPlanning().find(p => p.id === planningId);
            if (planning && planning.type === 'Pengeluaran' && type === 'expense') {
                const used = planning.used || 0;
                let currentTransactionAmount = 0;
                if (editingTransactionId) {
                    const oldTransaction = appData.transactions.find(t => t.id === editingTransactionId);
                    currentTransactionAmount = oldTransaction ? oldTransaction.amount : 0;
                }
                const projectedUsed = used - currentTransactionAmount + amount;
                if (projectedUsed > planning.target) {
                    if (!confirm(`Peringatan: Pengeluaran ini melebihi target planning!\nTarget: ${formatCurrency(planning.target)}\nSudah terpakai: ${formatCurrency(used)}\nTambah: ${formatCurrency(amount)}\nTotal akan jadi: ${formatCurrency(projectedUsed)}\nLanjutkan?`)) {
                        return;
                    }
                }
            }
            
            if (planning && planning.type === 'Pemasukan' && type === 'income') {
                const collected = planning.collected || 0;
                let currentTransactionAmount = 0;
                if (editingTransactionId) {
                    const oldTransaction = appData.transactions.find(t => t.id === editingTransactionId);
                    currentTransactionAmount = oldTransaction ? oldTransaction.amount : 0;
                }
                const projectedCollected = collected - currentTransactionAmount + amount;
                if (projectedCollected > planning.target) {
                    if (!confirm(`Peringatan: Pemasukan ini melebihi target planning!\nTarget: ${formatCurrency(planning.target)}\nSudah terkumpul: ${formatCurrency(collected)}\nTambah: ${formatCurrency(amount)}\nTotal akan jadi: ${formatCurrency(projectedCollected)}\nLanjutkan?`)) {
                        return;
                    }
                }
            }
            
            if (editingTransactionId) {
                // Update existing transaction
                const transactionIndex = appData.transactions.findIndex(t => t.id === editingTransactionId);
                if (transactionIndex !== -1) {
                    appData.transactions[transactionIndex] = {
                        ...appData.transactions[transactionIndex],
                        type: type,
                        planningId: planningId,
                        amount: amount,
                        description: description,
                        date: transDate
                    };
                    showToast('Transaksi berhasil diperbarui!');
                }
            } else {
                // Add new transaction
                const transaction = {
                    id: 'trans_' + Date.now(),
                    type: type,
                    planningId: planningId,
                    amount: amount,
                    description: description,
                    date: transDate
                };
                
                appData.transactions.push(transaction);
                showToast('Transaksi berhasil disimpan!');
            }
            
            saveData();
            
            // Reset form
            this.reset();
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('transDate').value = todayStr;
            document.getElementById('balanceInfo').style.display = 'none';
            document.getElementById('editingTransactionId').value = '';
            document.getElementById('transactionFormTitle').textContent = 'Tambah Transaksi';
            document.getElementById('transactionSubmitBtn').textContent = 'Simpan Transaksi';
            document.getElementById('cancelEditBtn').style.display = 'none';
        });
        
        // Cancel edit button
        document.getElementById('cancelEditBtn').addEventListener('click', function() {
            document.getElementById('transactionForm').reset();
            const today = new Date();
            document.getElementById('transDate').valueAsDate = today;
            document.getElementById('transDate').value = today.toISOString().split('T')[0];
            document.getElementById('balanceInfo').style.display = 'none';
            document.getElementById('editingTransactionId').value = '';
            document.getElementById('transactionFormTitle').textContent = 'Tambah Transaksi';
            document.getElementById('transactionSubmitBtn').textContent = 'Simpan Transaksi';
            this.style.display = 'none';
            showToast('Edit transaksi dibatalkan');
        });
        
        // Transaction month filter
        document.getElementById('transMonthFilter').addEventListener('change', function() {
            updateTransactionHistory();
        });
        
        // Delete planning
        window.deletePlanning = function(planningId) {
            const planning = getCurrentMonthPlanning().find(p => p.id === planningId);
            if (!planning) return;
            
            // Check if planning has transactions
            const planningTransactions = appData.transactions.filter(t => t.planningId === planningId);
            
            let message = `Hapus planning "${planning.name}"?`;
            if (planningTransactions.length > 0) {
                message += `\n\nPlanning ini memiliki ${planningTransactions.length} transaksi.`;
                message += `\nHapus planning dan semua transaksinya?`;
            }
            
            if (confirm(message)) {
                // Remove from monthly planning
                const monthKey = getCurrentMonthKey();
                appData.monthlyPlanning[monthKey] = appData.monthlyPlanning[monthKey].filter(p => p.id !== planningId);
                
                // Remove template if no other month uses it
                const otherMonths = Object.values(appData.monthlyPlanning).flat();
                const templateInUse = otherMonths.some(p => p.templateId === planning.templateId);
                if (!templateInUse) {
                    appData.planningTemplates = appData.planningTemplates.filter(t => t.id !== planning.templateId);
                }
                
                // Remove related transactions
                appData.transactions = appData.transactions.filter(t => t.planningId !== planningId);
                
                saveData();
                showToast(`Planning "${planning.name}" dihapus`);
            }
        };
        
        // Delete income source
        window.deleteIncomeSource = function(index) {
            const income = appData.incomeSources[index];
            if (confirm(`Hapus sumber pemasukan "${income.name}"?`)) {
                appData.incomeSources.splice(index, 1);
                saveData();
                showToast(`Sumber pemasukan "${income.name}" dihapus`);
            }
        };
        
        // Update year select
        function updateYearSelect() {
            const yearSelect = document.getElementById('reportYear');
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === appData.currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }
        
        // Export monthly report
        document.getElementById('exportMonthlyBtn').addEventListener('click', function() {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            generatePDFReport(year, month);
        });
        
        // Backup data
        document.getElementById('backupBtn').addEventListener('click', function() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `flexibudget_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('Data berhasil di-backup!');
        });
        
        // Restore data
        document.getElementById('restoreBtn').addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const backup = JSON.parse(e.target.result);
                        if (confirm('Restore data? Data saat ini akan diganti.')) {
                            appData = backup;
                            saveData();
                            showToast('Data berhasil di-restore!');
                        }
                    } catch (err) {
                        alert('File backup tidak valid!');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        });
        
        // Reset data
        document.getElementById('resetBtn').addEventListener('click', function() {
            if (confirm('RESET SEMUA DATA?\nIni akan menghapus semua data!')) {
                if (prompt('Ketik "RESET" untuk konfirmasi:') === 'RESET') {
                    localStorage.removeItem('flexibudget_advanced');
                    location.reload();
                }
            }
        });
        
        // Add year
        document.getElementById('addYearBtn').addEventListener('click', function() {
            const year = prompt('Masukkan tahun baru:', new Date().getFullYear() + 1);
            if (year && year >= 2000 && year <= 2100) {
                appData.currentYear = parseInt(year);
                appData.currentMonth = 0; // Reset ke Januari
                saveData();
                showToast(`Tahun aktif diubah ke ${year}`);
            }
        });
        
        // ========== INITIALIZE ==========
        
        function initApp() {
            loadData();
            
            // Set default date
            const today = new Date();
            document.getElementById('transDate').valueAsDate = today;
            document.getElementById('transDate').value = today.toISOString().split('T')[0];
            
            // Initialize month selectors
            document.getElementById('reportMonth').value = today.getMonth();
            updateYearSelect();
            
            // Create default templates if empty
            if (appData.planningTemplates.length === 0) {
                const defaultTemplates = [
                    {
                        id: 'template_transport',
                        name: 'TRANSPORT',
                        type: 'Pengeluaran',
                        target: 500000,
                        description: 'Transportasi bulanan'
                    },
                    {
                        id: 'template_gaji',
                        name: 'GAJI',
                        type: 'Pemasukan',
                        target: 3000000,
                        description: 'Gaji bulanan'
                    }
                ];
                
                appData.planningTemplates = defaultTemplates;
                
                const defaultIncome = [
                    {
                        id: 'income_gaji',
                        name: 'Gaji Pokok',
                        amount: 3000000,
                        description: 'Gaji bulanan tetap'
                    }
                ];
                
                appData.incomeSources = defaultIncome;
                
                saveData();
            }
            
            // Initialize current month planning
            getCurrentMonthPlanning();
            
            console.log('Aplikasi FlexiBudget siap!');
            console.log('Versi:', appData.version);
            console.log('Templates:', appData.planningTemplates.length);
            console.log('Transaksi:', appData.transactions.length);
            console.log('Bulan:', monthNames[appData.currentMonth], appData.currentYear);
        }
        
        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
