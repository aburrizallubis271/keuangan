<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexiBudget - Manajemen Usaha</title>
    <!-- Include jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #2d6a4f 0%, #1b4332 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* Header */
        .header {
            background: #2d6a4f;
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        .logo {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .back-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Navigation */
        .nav {
            display: flex;
            flex-wrap: wrap;
            background: #1b4332;
            border-bottom: 3px solid #1b4332;
        }
        
        .nav-btn {
            flex: 1;
            min-width: 60px;
            padding: 12px 5px;
            background: none;
            border: none;
            color: white;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .nav-btn.active {
            background: rgba(255,255,255,0.1);
            border-bottom-color: white;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .nav-btn .nav-icon {
            font-size: 16px;
            display: block;
            margin-bottom: 2px;
        }
        
        .nav-btn .nav-text {
            font-size: 10px;
        }
        
        /* Pages */
        .page {
            display: none;
            padding: 15px;
            animation: fadeIn 0.3s;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        h2 {
            color: #212529;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        input:focus, select:focus {
            border-color: #2d6a4f;
            outline: none;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: 0.3s;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: #2d6a4f;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1b4332;
        }
        
        .btn-block {
            width: 100%;
            margin-top: 8px;
        }
        
        .btn-success {
            background: #40916c;
            color: white;
        }
        
        .btn-danger {
            background: #e71d36;
            color: white;
        }
        
        .btn-info {
            background: #4361ee;
            color: white;
        }
        
        .btn-warning {
            background: #ff9f1c;
            color: white;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .btn-group {
            display: flex;
            gap: 5px;
        }
        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stats-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        @media (max-width: 768px) {
            .stats-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-4 {
                grid-template-columns: 1fr;
            }
        }
        
        .stat-card {
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100px;
        }
        
        .stat-card.modal {
            background: linear-gradient(135deg, #2d6a4f, #1b4332);
        }
        
        .stat-card.pemasukan {
            background: linear-gradient(135deg, #40916c, #2d6a4f);
        }
        
        .stat-card.pengeluaran {
            background: linear-gradient(135deg, #e71d36, #c1121f);
        }
        
        .stat-card.saldo {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #ff9f1c, #ff9100);
        }
        
        .stat-card.info {
            background: linear-gradient(135deg, #7209b7, #560bad);
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            margin: 8px 0;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .stat-change {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 4px;
        }
        
        /* Transaction Items */
        .trans-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }
        
        .trans-amount.income {
            color: #40916c;
            font-weight: bold;
        }
        
        .trans-amount.expense {
            color: #e71d36;
            font-weight: bold;
        }
        
        /* Modal Items */
        .modal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #2d6a4f;
        }
        
        .modal-info h4 {
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #6c757d;
            font-size: 14px;
        }
        
        /* Dashboard Progress */
        .progress-container {
            margin: 15px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #40916c;
            transition: width 0.3s;
        }
        
        .progress-fill.warning {
            background: #ff9f1c;
        }
        
        .progress-fill.danger {
            background: #e71d36;
        }
        
        /* Financial Status */
        .status-card {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-profit {
            background: #e7f5ff;
            border-left: 4px solid #40916c;
            color: #40916c;
        }
        
        .status-loss {
            background: #fff5f5;
            border-left: 4px solid #e71d36;
            color: #e71d36;
        }
        
        .status-breakeven {
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            color: #6c757d;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .quick-action {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.3s;
        }
        
        .quick-action:hover {
            background: white;
            border-color: #2d6a4f;
        }
        
        .quick-action-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 15px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6c757d;
        }
        
        /* Month Navigation */
        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .month-nav-btn {
            background: #2d6a4f;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .month-nav-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .current-month {
            font-weight: bold;
            color: #2d6a4f;
            font-size: 16px;
        }
        
        /* Settings Menu */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .menu-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.3s;
        }
        
        .menu-item:hover {
            background: white;
            border-color: #2d6a4f;
        }
        
        .menu-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .stats, .stats-4 {
                grid-template-columns: 1fr;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-btn {
                min-width: 50px;
                padding: 10px 3px;
            }
            
            .nav-btn .nav-icon {
                font-size: 14px;
            }
            
            .nav-btn .nav-text {
                font-size: 9px;
            }
            
            .back-btn {
                position: relative;
                left: 0;
                margin-bottom: 10px;
                width: 100%;
            }
            
            .header {
                padding-top: 25px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                max-width: 800px;
            }
        }
        
        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .loading.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2d6a4f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d6a4f;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="back-btn" onclick="window.location.href='index.html'">
                ‚Üê Kembali
            </button>
            <div class="logo">üè¢ FlexiBudget Usaha</div>
            <div style="font-size: 12px; opacity: 0.9;">Manajemen Keuangan Usaha</div>
        </div>
        
        <!-- Navigation -->
        <div class="nav">
            <button class="nav-btn active" data-page="dashboard">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </button>
            <button class="nav-btn" data-page="modal">
                <span class="nav-icon">üí∞</span>
                <span class="nav-text">Modal</span>
            </button>
            <button class="nav-btn" data-page="pengeluaran">
                <span class="nav-icon">üì§</span>
                <span class="nav-text">Pengeluaran</span>
            </button>
            <button class="nav-btn" data-page="pemasukan">
                <span class="nav-icon">üì•</span>
                <span class="nav-text">Pemasukan</span>
            </button>
            <button class="nav-btn" data-page="saldo">
                <span class="nav-icon">üíµ</span>
                <span class="nav-text">Saldo</span>
            </button>
            <button class="nav-btn" data-page="laporan">
                <span class="nav-icon">üìà</span>
                <span class="nav-text">Laporan</span>
            </button>
            <button class="nav-btn" data-page="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
            </button>
        </div>
        
        <!-- Dashboard Page -->
        <div class="page active" id="dashboard">
            <div class="month-nav">
                <button class="month-nav-btn" id="prevMonthBtnDashboard">‚Üê Bulan Sebelumnya</button>
                <div class="current-month" id="currentMonthYearDashboard">Januari 2024</div>
                <button class="month-nav-btn" id="nextMonthBtnDashboard">Bulan Berikutnya ‚Üí</button>
            </div>
            
            <!-- Real-time Stats -->
            <div class="stats stats-4">
                <div class="stat-card modal">
                    <div class="stat-label">Total Modal</div>
                    <div class="stat-value" id="dashboardModal">Rp 0</div>
                    <div class="stat-change" id="modalChange">Bulan ini</div>
                </div>
                <div class="stat-card pemasukan">
                    <div class="stat-label">Total Pemasukan</div>
                    <div class="stat-value" id="dashboardPemasukan">Rp 0</div>
                    <div class="stat-change" id="pemasukanChange">Bulan ini</div>
                </div>
                <div class="stat-card pengeluaran">
                    <div class="stat-label">Total Pengeluaran</div>
                    <div class="stat-value" id="dashboardPengeluaran">Rp 0</div>
                    <div class="stat-change" id="pengeluaranChange">Bulan ini</div>
                </div>
                <div class="stat-card saldo">
                    <div class="stat-label">Saldo Akhir</div>
                    <div class="stat-value" id="dashboardSaldo">Rp 0</div>
                    <div class="stat-change" id="saldoChange">Bulan ini</div>
                </div>
            </div>
            
            <!-- Financial Status -->
            <div class="card">
                <h2>Status Keuangan</h2>
                <div id="dashboardStatus">
                    <div class="empty-state">Belum ada transaksi</div>
                </div>
                
                <!-- Progress Bars -->
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Penggunaan Modal</span>
                        <span id="modalUsagePercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="modalUsageBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Rasio Pemasukan/Pengeluaran</span>
                        <span id="incomeExpenseRatio">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="incomeExpenseBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Summary -->
            <div class="card">
                <h2>Ringkasan Cepat</h2>
                <div class="stats">
                    <div class="stat-card warning">
                        <div class="stat-label">Rata-rata Pemasukan/Hari</div>
                        <div class="stat-value" id="avgIncomePerDay">Rp 0</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-label">Rata-rata Pengeluaran/Hari</div>
                        <div class="stat-value" id="avgExpensePerDay">Rp 0</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Modal Tersisa:</span>
                        <span id="remainingModalText">Rp 0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Laba/Rugi Bersih:</span>
                        <span id="netProfitText">Rp 0</span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <h2>Aksi Cepat</h2>
                <div class="quick-actions">
                    <div class="quick-action" onclick="switchToPage('modal')">
                        <div class="quick-action-icon">üí∞</div>
                        <div>Tambah Modal</div>
                    </div>
                    <div class="quick-action" onclick="switchToPage('pengeluaran')">
                        <div class="quick-action-icon">üì§</div>
                        <div>Tambah Pengeluaran</div>
                    </div>
                    <div class="quick-action" onclick="switchToPage('pemasukan')">
                        <div class="quick-action-icon">üì•</div>
                        <div>Tambah Pemasukan</div>
                    </div>
                    <div class="quick-action" onclick="switchToPage('laporan')">
                        <div class="quick-action-icon">üìÑ</div>
                        <div>Buat Laporan</div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Transactions -->
            <div class="card">
                <h2>Transaksi Terbaru</h2>
                <div id="dashboardRecentTransactions">
                    <div class="empty-state">Belum ada transaksi</div>
                </div>
            </div>
        </div>
        
        <!-- Modal Page -->
        <div class="page" id="modal">
            <div class="month-nav">
                <button class="month-nav-btn" id="prevMonthBtnModal">‚Üê Bulan Sebelumnya</button>
                <div class="current-month" id="currentMonthYearModal">Januari 2024</div>
                <button class="month-nav-btn" id="nextMonthBtnModal">Bulan Berikutnya ‚Üí</button>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Modal Awal</div>
                    <div class="stat-value" id="modalAwal">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Modal Digunakan</div>
                    <div class="stat-value" id="modalTerpakai">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sisa Modal</div>
                    <div class="stat-value" id="sisaModal">Rp 0</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Kelola Modal</h2>
                <button class="btn btn-primary btn-block" id="tambahModalBtn">+ Tambah Modal</button>
                
                <div style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Keterangan Modal</label>
                        <input type="text" id="modalDesc" placeholder="Contoh: Modal awal usaha, Tambahan modal">
                    </div>
                    <div class="form-group">
                        <label>Jumlah Modal (Rp)</label>
                        <input type="number" id="modalAmount" min="0">
                    </div>
                    <button class="btn btn-success btn-block" id="simpanModalBtn">üíæ Simpan Modal</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Riwayat Modal</h2>
                <div id="modalHistory">
                    <div class="empty-state">Belum ada data modal</div>
                </div>
            </div>
        </div>
        
        <!-- Pengeluaran Page -->
        <div class="page" id="pengeluaran">
            <div class="month-nav">
                <button class="month-nav-btn" id="prevMonthBtnExpense">‚Üê Bulan Sebelumnya</button>
                <div class="current-month" id="currentMonthYearExpense">Januari 2024</div>
                <button class="month-nav-btn" id="nextMonthBtnExpense">Bulan Berikutnya ‚Üí</button>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Pengeluaran</div>
                    <div class="stat-value" id="totalPengeluaran">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pengeluaran Terbesar</div>
                    <div class="stat-value" id="pengeluaranTerbesar">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Rata-rata/hari</div>
                    <div class="stat-value" id="rataPengeluaran">Rp 0</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Tambah Pengeluaran</h2>
                <form id="expenseForm">
                    <div class="form-group">
                        <label>Kategori</label>
                        <select id="expenseCategory" required>
                            <option value="">Pilih kategori</option>
                            <option value="Bahan Baku">Bahan Baku</option>
                            <option value="Operasional">Operasional</option>
                            <option value="Gaji Karyawan">Gaji Karyawan</option>
                            <option value="Sewa Tempat">Sewa Tempat</option>
                            <option value="Listrik/Air">Listrik/Air</option>
                            <option value="Transportasi">Transportasi</option>
                            <option value="Pemasaran">Pemasaran</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Jumlah (Rp)</label>
                        <input type="number" id="expenseAmount" required min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Keterangan</label>
                        <input type="text" id="expenseDesc" placeholder="Contoh: Beli bahan baku, Bayar gaji karyawan">
                    </div>
                    
                    <div class="form-group">
                        <label>Tanggal</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">Simpan Pengeluaran</button>
                </form>
            </div>
            
            <div class="card">
                <h2>Riwayat Pengeluaran</h2>
                <div id="expenseHistory">
                    <div class="empty-state">Belum ada pengeluaran</div>
                </div>
            </div>
        </div>
        
        <!-- Pemasukan Page -->
        <div class="page" id="pemasukan">
            <div class="month-nav">
                <button class="month-nav-btn" id="prevMonthBtnIncome">‚Üê Bulan Sebelumnya</button>
                <div class="current-month" id="currentMonthYearIncome">Januari 2024</div>
                <button class="month-nav-btn" id="nextMonthBtnIncome">Bulan Berikutnya ‚Üí</button>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Pemasukan</div>
                    <div class="stat-value" id="totalPemasukan">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pemasukan Terbesar</div>
                    <div class="stat-value" id="pemasukanTerbesar">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Rata-rata/hari</div>
                    <div class="stat-value" id="rataPemasukan">Rp 0</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Tambah Pemasukan</h2>
                <form id="incomeForm">
                    <div class="form-group">
                        <label>Sumber Pemasukan</label>
                        <select id="incomeSource" required>
                            <option value="">Pilih sumber</option>
                            <option value="Penjualan">Penjualan</option>
                            <option value="Jasa">Jasa</option>
                            <option value="Investasi">Investasi</option>
                            <option value="Hibah">Hibah</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Jumlah (Rp)</label>
                        <input type="number" id="incomeAmount" required min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Keterangan</label>
                        <input type="text" id="incomeDesc" placeholder="Contoh: Penjualan produk, Pendapatan jasa">
                    </div>
                    
                    <div class="form-group">
                        <label>Tanggal</label>
                        <input type="date" id="incomeDate" required>
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-block">Simpan Pemasukan</button>
                </form>
            </div>
            
            <div class="card">
                <h2>Riwayat Pemasukan</h2>
                <div id="incomeHistory">
                    <div class="empty-state">Belum ada pemasukan</div>
                </div>
            </div>
        </div>
        
        <!-- Saldo Page -->
        <div class="page" id="saldo">
            <div class="month-nav">
                <button class="month-nav-btn" id="prevMonthBtnBalance">‚Üê Bulan Sebelumnya</button>
                <div class="current-month" id="currentMonthYearBalance">Januari 2024</div>
                <button class="month-nav-btn" id="nextMonthBtnBalance">Bulan Berikutnya ‚Üí</button>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Modal</div>
                    <div class="stat-value" id="totalModal">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Pemasukan</div>
                    <div class="stat-value" id="saldoPemasukan">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Pengeluaran</div>
                    <div class="stat-value" id="saldoPengeluaran">Rp 0</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Ringkasan Keuangan</h2>
                <div id="balanceSummary">
                    <div class="empty-state">Belum ada data keuangan</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Status Keuangan</h2>
                <div id="financialStatus">
                    <div class="empty-state">Belum ada transaksi</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Transaksi Terbaru</h2>
                <div id="recentTransactions">
                    <div class="empty-state">Belum ada transaksi</div>
                </div>
            </div>
        </div>
        
        <!-- Laporan Page -->
        <div class="page" id="laporan">
            <div class="card">
                <h2>Laporan Bulanan</h2>
                
                <div class="form-group">
                    <label>Pilih Bulan</label>
                    <select id="reportMonth" style="margin-bottom: 10px;">
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Pilih Tahun</label>
                    <select id="reportYear"></select>
                </div>
                
                <div id="monthlyReport">
                    <div class="empty-state">Pilih bulan dan tahun</div>
                </div>
                
                <button class="btn btn-primary btn-block" id="exportMonthlyBtn">
                    üìÑ Download Laporan PDF
                </button>
            </div>
            
            <div class="card">
                <h2>Statistik Bulan Ini</h2>
                <div id="monthStats">
                    <div class="empty-state">Belum ada data</div>
                </div>
            </div>
        </div>
        
        <!-- Settings Page -->
        <div class="page" id="settings">
            <div class="menu-grid">
                <div class="menu-item" id="backupBtn">
                    <div class="menu-icon">üíæ</div>
                    <div>Backup Data</div>
                </div>
                <div class="menu-item" id="restoreBtn">
                    <div class="menu-icon">üîÑ</div>
                    <div>Restore Data</div>
                </div>
                <div class="menu-item" id="resetBtn">
                    <div class="menu-icon">üóëÔ∏è</div>
                    <div>Reset Data</div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 15px;">
                <h2>Informasi Usaha</h2>
                <p><strong>Versi:</strong> 1.0</p>
                <p><strong>Tahun Aktif:</strong> <span id="currentYear">2024</span></p>
                <p><strong>Modal:</strong> <span id="totalModalCount">0 transaksi</span></p>
                <p><strong>Pengeluaran:</strong> <span id="totalExpenseCount">0 transaksi</span></p>
                <p><strong>Pemasukan:</strong> <span id="totalIncomeCount">0 transaksi</span></p>
                <p><strong>Data Tersimpan:</strong> <span id="dataSize">0 KB</span></p>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Kelola Kategori</h3>
                <button class="close-btn" id="closeCategoryBtn">√ó</button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <div class="form-group">
                        <label>Nama Kategori Baru</label>
                        <input type="text" id="newCategoryName" placeholder="Masukkan nama kategori">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Tambah Kategori</button>
                </form>
                
                <div style="margin-top: 20px;">
                    <h4>Kategori Tersedia</h4>
                    <div id="categoryList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // ========== APLIKASI USAHA ==========
        
        // Data structure untuk usaha
        let businessData = {
            version: "1.0",
            currentYear: new Date().getFullYear(),
            currentMonth: new Date().getMonth(),
            modal: [],          // Data modal per bulan
            expenses: [],       // Data pengeluaran
            incomes: [],        // Data pemasukan
            categories: [       // Kategori default
                "Bahan Baku",
                "Operasional", 
                "Gaji Karyawan",
                "Sewa Tempat",
                "Listrik/Air",
                "Transportasi",
                "Pemasaran",
                "Lainnya"
            ],
            incomeSources: [    // Sumber pemasukan default
                "Penjualan",
                "Jasa",
                "Investasi",
                "Hibah",
                "Lainnya"
            ]
        };
        
        // Nama bulan
        const monthNames = [
            "Januari", "Februari", "Maret", "April", "Mei", "Juni",
            "Juli", "Agustus", "September", "Oktober", "November", "Desember"
        ];
        
        // ========== FUNGSI UTAMA ==========
        
        // Load data
        function loadData() {
            const saved = localStorage.getItem('flexibudget_business');
            if (saved) {
                businessData = JSON.parse(saved);
                // Initialize arrays jika belum ada
                if (!businessData.modal) businessData.modal = [];
                if (!businessData.expenses) businessData.expenses = [];
                if (!businessData.incomes) businessData.incomes = [];
                if (!businessData.categories) businessData.categories = [];
                if (!businessData.incomeSources) businessData.incomeSources = [];
            }
        }
        
        // Save data
        function saveData() {
            localStorage.setItem('flexibudget_business', JSON.stringify(businessData));
            updateDisplay();
            updateDataSize();
        }
        
        // Update data size display
        function updateDataSize() {
            const data = localStorage.getItem('flexibudget_business');
            const size = data ? (data.length / 1024).toFixed(2) : '0';
            document.getElementById('dataSize').textContent = size + ' KB';
        }
        
        // Get current month key
        function getCurrentMonthKey() {
            return `${businessData.currentYear}-${businessData.currentMonth}`;
        }
        
        // Get modal for current month
        function getCurrentMonthModal() {
            const monthKey = getCurrentMonthKey();
            return businessData.modal.filter(m => {
                const date = new Date(m.date);
                return date.getFullYear() === businessData.currentYear && 
                       date.getMonth() === businessData.currentMonth;
            });
        }
        
        // Get expenses for current month
        function getCurrentMonthExpenses() {
            const monthKey = getCurrentMonthKey();
            return businessData.expenses.filter(e => {
                const date = new Date(e.date);
                return date.getFullYear() === businessData.currentYear && 
                       date.getMonth() === businessData.currentMonth;
            });
        }
        
        // Get incomes for current month
        function getCurrentMonthIncomes() {
            const monthKey = getCurrentMonthKey();
            return businessData.incomes.filter(i => {
                const date = new Date(i.date);
                return date.getFullYear() === businessData.currentYear && 
                       date.getMonth() === businessData.currentMonth;
            });
        }
        
        // Get previous month data for comparison
        function getPreviousMonthData() {
            let prevYear = businessData.currentYear;
            let prevMonth = businessData.currentMonth - 1;
            
            if (prevMonth < 0) {
                prevMonth = 11;
                prevYear--;
            }
            
            const prevModal = businessData.modal.filter(m => {
                const date = new Date(m.date);
                return date.getFullYear() === prevYear && 
                       date.getMonth() === prevMonth;
            });
            
            const prevExpenses = businessData.expenses.filter(e => {
                const date = new Date(e.date);
                return date.getFullYear() === prevYear && 
                       date.getMonth() === prevMonth;
            });
            
            const prevIncomes = businessData.incomes.filter(i => {
                const date = new Date(i.date);
                return date.getFullYear() === prevYear && 
                       date.getMonth() === prevMonth;
            });
            
            return {
                modal: prevModal.reduce((sum, m) => sum + m.amount, 0),
                expenses: prevExpenses.reduce((sum, e) => sum + e.amount, 0),
                incomes: prevIncomes.reduce((sum, i) => sum + i.amount, 0)
            };
        }
        
        // Calculate modal totals
        function calculateModalTotals() {
            const currentMonthModal = getCurrentMonthModal();
            const modalAwal = currentMonthModal.reduce((sum, m) => sum + m.amount, 0);
            
            const modalTerpakai = getCurrentMonthExpenses().reduce((sum, e) => sum + e.amount, 0);
            
            const sisaModal = Math.max(0, modalAwal - modalTerpakai);
            
            return { modalAwal, modalTerpakai, sisaModal };
        }
        
        // Calculate expense totals
        function calculateExpenseTotals() {
            const currentMonthExpenses = getCurrentMonthExpenses();
            const total = currentMonthExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            const terbesar = currentMonthExpenses.length > 0 ? 
                Math.max(...currentMonthExpenses.map(e => e.amount)) : 0;
            
            const hariDalamBulan = new Date(businessData.currentYear, businessData.currentMonth + 1, 0).getDate();
            const rata = total > 0 ? Math.round(total / hariDalamBulan) : 0;
            
            return { total, terbesar, rata };
        }
        
        // Calculate income totals
        function calculateIncomeTotals() {
            const currentMonthIncomes = getCurrentMonthIncomes();
            const total = currentMonthIncomes.reduce((sum, i) => sum + i.amount, 0);
            
            const terbesar = currentMonthIncomes.length > 0 ? 
                Math.max(...currentMonthIncomes.map(i => i.amount)) : 0;
            
            const hariDalamBulan = new Date(businessData.currentYear, businessData.currentMonth + 1, 0).getDate();
            const rata = total > 0 ? Math.round(total / hariDalamBulan) : 0;
            
            return { total, terbesar, rata };
        }
        
        // Calculate balance totals
        function calculateBalanceTotals() {
            const modal = calculateModalTotals();
            const expense = calculateExpenseTotals();
            const income = calculateIncomeTotals();
            
            return {
                totalModal: modal.modalAwal,
                totalPemasukan: income.total,
                totalPengeluaran: expense.total,
                saldoAkhir: (modal.modalAwal + income.total) - expense.total
            };
        }
        
        // Show toast notification
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // Show loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        // Hide loading
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        // Switch to page
        function switchToPage(pageId) {
            // Remove active from all
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active');
            });
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            // Add active to target
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            document.getElementById(pageId).classList.add('active');
            
            // Refresh page content
            updateDisplay();
        }
        
        // Update display
        function updateDisplay() {
            // Update all pages
            updateDashboardPage();
            updateModalPage();
            updateExpensePage();
            updateIncomePage();
            updateBalancePage();
            updateReportPage();
            updateSettingsPage();
            
            // Update current month display
            updateMonthDisplay();
        }
        
        // Update month display
        function updateMonthDisplay() {
            const currentMonth = monthNames[businessData.currentMonth];
            const yearMonth = `${currentMonth} ${businessData.currentYear}`;
            
            // Update all month displays
            document.getElementById('currentMonthYearDashboard').textContent = yearMonth;
            document.getElementById('currentMonthYearModal').textContent = yearMonth;
            document.getElementById('currentMonthYearExpense').textContent = yearMonth;
            document.getElementById('currentMonthYearIncome').textContent = yearMonth;
            document.getElementById('currentMonthYearBalance').textContent = yearMonth;
        }
        
        // Update dashboard page
        function updateDashboardPage() {
            // Calculate all totals
            const modalTotals = calculateModalTotals();
            const expenseTotals = calculateExpenseTotals();
            const incomeTotals = calculateIncomeTotals();
            const balanceTotals = calculateBalanceTotals();
            
            // Get previous month data for comparison
            const prevMonthData = getPreviousMonthData();
            
            // Update real-time stats
            document.getElementById('dashboardModal').textContent = formatCurrency(modalTotals.modalAwal);
            document.getElementById('dashboardPemasukan').textContent = formatCurrency(incomeTotals.total);
            document.getElementById('dashboardPengeluaran').textContent = formatCurrency(expenseTotals.total);
            document.getElementById('dashboardSaldo').textContent = formatCurrency(balanceTotals.saldoAkhir);
            
            // Calculate and display changes from previous month
            const modalChange = modalTotals.modalAwal - prevMonthData.modal;
            const pemasukanChange = incomeTotals.total - prevMonthData.incomes;
            const pengeluaranChange = expenseTotals.total - prevMonthData.expenses;
            const saldoChange = balanceTotals.saldoAkhir - (prevMonthData.modal + prevMonthData.incomes - prevMonthData.expenses);
            
            document.getElementById('modalChange').textContent = 
                formatChange(modalChange, prevMonthData.modal);
            document.getElementById('pemasukanChange').textContent = 
                formatChange(pemasukanChange, prevMonthData.incomes);
            document.getElementById('pengeluaranChange').textContent = 
                formatChange(pengeluaranChange, prevMonthData.expenses);
            document.getElementById('saldoChange').textContent = 
                formatChange(saldoChange, prevMonthData.modal + prevMonthData.incomes - prevMonthData.expenses);
            
            // Update financial status
            updateDashboardStatus(balanceTotals);
            
            // Update progress bars
            updateDashboardProgress(modalTotals, incomeTotals, expenseTotals);
            
            // Update quick summary
            updateDashboardSummary(modalTotals, expenseTotals, incomeTotals);
            
            // Update recent transactions
            updateDashboardRecentTransactions();
        }
        
        // Format change for display
        function formatChange(change, previous) {
            if (previous === 0) {
                return change === 0 ? 'Tidak ada data sebelumnya' : 'Baru';
            }
            
            const percentage = ((change / previous) * 100).toFixed(1);
            const sign = change >= 0 ? '+' : '';
            
            if (change === 0) return 'Tidak berubah';
            return `${sign}${formatCurrency(Math.abs(change))} (${sign}${Math.abs(percentage)}%)`;
        }
        
        // Update dashboard status
        function updateDashboardStatus(balanceTotals) {
            const container = document.getElementById('dashboardStatus');
            
            let statusHtml = '';
            if (balanceTotals.saldoAkhir > balanceTotals.totalModal) {
                const profit = balanceTotals.saldoAkhir - balanceTotals.totalModal;
                const profitPercentage = ((profit / balanceTotals.totalModal) * 100).toFixed(1);
                statusHtml = `
                    <div class="status-profit">
                        ‚úÖ <strong>UNTUNG</strong><br>
                        Keuntungan: ${formatCurrency(profit)} (${profitPercentage}%)
                    </div>
                `;
            } else if (balanceTotals.saldoAkhir < balanceTotals.totalModal) {
                const loss = balanceTotals.totalModal - balanceTotals.saldoAkhir;
                const lossPercentage = ((loss / balanceTotals.totalModal) * 100).toFixed(1);
                statusHtml = `
                    <div class="status-loss">
                        ‚ö†Ô∏è <strong>RUGI</strong><br>
                        Kerugian: ${formatCurrency(loss)} (${lossPercentage}%)
                    </div>
                `;
            } else {
                statusHtml = `
                    <div class="status-breakeven">
                        ‚öñÔ∏è <strong>BREAK EVEN</strong><br>
                        Tidak ada untung atau rugi
                    </div>
                `;
            }
            
            container.innerHTML = statusHtml;
        }
        
        // Update dashboard progress bars
        function updateDashboardProgress(modalTotals, incomeTotals, expenseTotals) {
            // Modal usage
            const modalUsagePercent = modalTotals.modalAwal > 0 ? 
                Math.min(100, (modalTotals.modalTerpakai / modalTotals.modalAwal) * 100) : 0;
            
            document.getElementById('modalUsagePercent').textContent = `${modalUsagePercent.toFixed(1)}%`;
            document.getElementById('modalUsageBar').style.width = `${modalUsagePercent}%`;
            
            // Set color based on usage
            const modalBar = document.getElementById('modalUsageBar');
            if (modalUsagePercent > 80) {
                modalBar.className = 'progress-fill danger';
            } else if (modalUsagePercent > 50) {
                modalBar.className = 'progress-fill warning';
            } else {
                modalBar.className = 'progress-fill';
            }
            
            // Income/Expense ratio
            const incomeExpenseRatio = expenseTotals.total > 0 ? 
                (incomeTotals.total / expenseTotals.total) * 100 : 0;
            
            document.getElementById('incomeExpenseRatio').textContent = `${incomeExpenseRatio.toFixed(1)}%`;
            document.getElementById('incomeExpenseBar').style.width = `${Math.min(100, incomeExpenseRatio)}%`;
            
            // Set color based on ratio
            const ratioBar = document.getElementById('incomeExpenseBar');
            if (incomeExpenseRatio > 100) {
                ratioBar.className = 'progress-fill';
            } else if (incomeExpenseRatio > 50) {
                ratioBar.className = 'progress-fill warning';
            } else {
                ratioBar.className = 'progress-fill danger';
            }
        }
        
        // Update dashboard summary
        function updateDashboardSummary(modalTotals, expenseTotals, incomeTotals) {
            // Calculate daily averages
            const hariDalamBulan = new Date(businessData.currentYear, businessData.currentMonth + 1, 0).getDate();
            const hariBerjalan = Math.min(hariDalamBulan, new Date().getDate());
            
            const avgIncomePerDay = hariBerjalan > 0 ? Math.round(incomeTotals.total / hariBerjalan) : 0;
            const avgExpensePerDay = hariBerjalan > 0 ? Math.round(expenseTotals.total / hariBerjalan) : 0;
            
            document.getElementById('avgIncomePerDay').textContent = formatCurrency(avgIncomePerDay);
            document.getElementById('avgExpensePerDay').textContent = formatCurrency(avgExpensePerDay);
            
            // Update remaining modal and net profit
            document.getElementById('remainingModalText').textContent = formatCurrency(modalTotals.sisaModal);
            
            const netProfit = incomeTotals.total - expenseTotals.total;
            const netProfitElement = document.getElementById('netProfitText');
            netProfitElement.textContent = formatCurrency(netProfit);
            netProfitElement.style.color = netProfit >= 0 ? '#40916c' : '#e71d36';
        }
        
        // Update dashboard recent transactions
        function updateDashboardRecentTransactions() {
            const container = document.getElementById('dashboardRecentTransactions');
            
            // Get all transactions for current month
            const allTransactions = [
                ...getCurrentMonthIncomes().map(i => ({...i, type: 'income', label: i.source})),
                ...getCurrentMonthExpenses().map(e => ({...e, type: 'expense', label: e.category})),
                ...getCurrentMonthModal().map(m => ({...m, type: 'modal', label: 'Modal'}))
            ];
            
            // Sort by date (newest first)
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Get 5 most recent
            const recent = allTransactions.slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada transaksi</div>';
                return;
            }
            
            container.innerHTML = '';
            recent.forEach(trans => {
                const div = document.createElement('div');
                div.className = 'trans-item';
                
                if (trans.type === 'income') {
                    div.innerHTML = `
                        <div>
                            <strong>Pemasukan: ${trans.label}</strong><br>
                            <small>${trans.description || '-'} ‚Ä¢ ${formatDate(trans.date)}</small>
                        </div>
                        <div class="trans-amount income">
                            + ${formatCurrency(trans.amount)}
                        </div>
                    `;
                } else if (trans.type === 'expense') {
                    div.innerHTML = `
                        <div>
                            <strong>Pengeluaran: ${trans.label}</strong><br>
                            <small>${trans.description || '-'} ‚Ä¢ ${formatDate(trans.date)}</small>
                        </div>
                        <div class="trans-amount expense">
                            - ${formatCurrency(trans.amount)}
                        </div>
                    `;
                } else if (trans.type === 'modal') {
                    div.innerHTML = `
                        <div>
                            <strong>Modal: ${trans.description || 'Tambahan Modal'}</strong><br>
                            <small>${formatDate(trans.date)}</small>
                        </div>
                        <div style="font-weight: bold; color: #2d6a4f;">
                            + ${formatCurrency(trans.amount)}
                        </div>
                    `;
                }
                
                container.appendChild(div);
            });
        }
        
        // Update modal page
        function updateModalPage() {
            const totals = calculateModalTotals();
            
            // Update stats
            document.getElementById('modalAwal').textContent = formatCurrency(totals.modalAwal);
            document.getElementById('modalTerpakai').textContent = formatCurrency(totals.modalTerpakai);
            document.getElementById('sisaModal').textContent = formatCurrency(totals.sisaModal);
            
            // Update modal history
            updateModalHistory();
        }
        
        // Update modal history
        function updateModalHistory() {
            const container = document.getElementById('modalHistory');
            const currentMonthModal = getCurrentMonthModal();
            
            if (currentMonthModal.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada data modal</div>';
                return;
            }
            
            container.innerHTML = '';
            currentMonthModal.forEach((modal, index) => {
                const div = document.createElement('div');
                div.className = 'modal-item';
                div.innerHTML = `
                    <div class="modal-info">
                        <h4>${modal.description}</h4>
                        <small>${formatDate(modal.date)}</small>
                    </div>
                    <div>
                        <div style="font-weight: bold; color: #2d6a4f;">${formatCurrency(modal.amount)}</div>
                        <button class="btn btn-danger btn-sm" onclick="deleteModal(${index})">Hapus</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Update expense page
        function updateExpensePage() {
            const totals = calculateExpenseTotals();
            
            // Update stats
            document.getElementById('totalPengeluaran').textContent = formatCurrency(totals.total);
            document.getElementById('pengeluaranTerbesar').textContent = formatCurrency(totals.terbesar);
            document.getElementById('rataPengeluaran').textContent = formatCurrency(totals.rata);
            
            // Update expense history
            updateExpenseHistory();
        }
        
        // Update expense history
        function updateExpenseHistory() {
            const container = document.getElementById('expenseHistory');
            const currentMonthExpenses = getCurrentMonthExpenses();
            
            if (currentMonthExpenses.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada pengeluaran</div>';
                return;
            }
            
            container.innerHTML = '';
            currentMonthExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            currentMonthExpenses.forEach((expense, index) => {
                const div = document.createElement('div');
                div.className = 'trans-item';
                div.innerHTML = `
                    <div>
                        <strong>${expense.category}</strong><br>
                        <small>${expense.description || '-'} ‚Ä¢ ${formatDate(expense.date)}</small>
                    </div>
                    <div class="trans-amount expense">
                        - ${formatCurrency(expense.amount)}
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Update income page
        function updateIncomePage() {
            const totals = calculateIncomeTotals();
            
            // Update stats
            document.getElementById('totalPemasukan').textContent = formatCurrency(totals.total);
            document.getElementById('pemasukanTerbesar').textContent = formatCurrency(totals.terbesar);
            document.getElementById('rataPemasukan').textContent = formatCurrency(totals.rata);
            
            // Update income history
            updateIncomeHistory();
        }
        
        // Update income history
        function updateIncomeHistory() {
            const container = document.getElementById('incomeHistory');
            const currentMonthIncomes = getCurrentMonthIncomes();
            
            if (currentMonthIncomes.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada pemasukan</div>';
                return;
            }
            
            container.innerHTML = '';
            currentMonthIncomes.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            currentMonthIncomes.forEach((income, index) => {
                const div = document.createElement('div');
                div.className = 'trans-item';
                div.innerHTML = `
                    <div>
                        <strong>${income.source}</strong><br>
                        <small>${income.description || '-'} ‚Ä¢ ${formatDate(income.date)}</small>
                    </div>
                    <div class="trans-amount income">
                        + ${formatCurrency(income.amount)}
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Update balance page
        function updateBalancePage() {
            const totals = calculateBalanceTotals();
            
            // Update stats
            document.getElementById('totalModal').textContent = formatCurrency(totals.totalModal);
            document.getElementById('saldoPemasukan').textContent = formatCurrency(totals.totalPemasukan);
            document.getElementById('saldoPengeluaran').textContent = formatCurrency(totals.totalPengeluaran);
            
            // Update balance summary
            updateBalanceSummary();
            
            // Update financial status
            updateFinancialStatus();
            
            // Update recent transactions
            updateRecentTransactions();
        }
        
        // Update balance summary
        function updateBalanceSummary() {
            const container = document.getElementById('balanceSummary');
            const totals = calculateBalanceTotals();
            
            const html = `
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Total Modal:</span>
                        <span style="font-weight: bold;">${formatCurrency(totals.totalModal)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Total Pemasukan:</span>
                        <span style="font-weight: bold; color: #40916c;">+ ${formatCurrency(totals.totalPemasukan)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Total Pengeluaran:</span>
                        <span style="font-weight: bold; color: #e71d36;">- ${formatCurrency(totals.totalPengeluaran)}</span>
                    </div>
                    <hr style="margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>Saldo Akhir:</strong></span>
                        <span style="font-weight: bold; font-size: 18px; color: ${totals.saldoAkhir >= 0 ? '#2d6a4f' : '#e71d36'}">
                            ${formatCurrency(totals.saldoAkhir)}
                        </span>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Update financial status
        function updateFinancialStatus() {
            const container = document.getElementById('financialStatus');
            const totals = calculateBalanceTotals();
            
            let statusText = '';
            if (totals.saldoAkhir > totals.totalModal) {
                statusText = `‚úÖ <strong>UNTUNG</strong><br>
                             Keuntungan: ${formatCurrency(totals.saldoAkhir - totals.totalModal)}<br>
                             <small>Saldo akhir lebih besar dari modal awal</small>`;
            } else if (totals.saldoAkhir < totals.totalModal) {
                statusText = `‚ö†Ô∏è <strong>RUGI</strong><br>
                             Kerugian: ${formatCurrency(totals.totalModal - totals.saldoAkhir)}<br>
                             <small>Saldo akhir lebih kecil dari modal awal</small>`;
            } else {
                statusText = `‚öñÔ∏è <strong>BREAK EVEN</strong><br>
                             <small>Tidak ada untung atau rugi</small>`;
            }
            
            container.innerHTML = statusText;
        }
        
        // Update recent transactions
        function updateRecentTransactions() {
            const container = document.getElementById('recentTransactions');
            
            // Get all transactions for current month
            const allTransactions = [
                ...getCurrentMonthIncomes().map(i => ({...i, type: 'income'})),
                ...getCurrentMonthExpenses().map(e => ({...e, type: 'expense'}))
            ];
            
            // Sort by date (newest first)
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Get 5 most recent
            const recent = allTransactions.slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state">Belum ada transaksi</div>';
                return;
            }
            
            container.innerHTML = '';
            recent.forEach(trans => {
                const div = document.createElement('div');
                div.className = 'trans-item';
                
                if (trans.type === 'income') {
                    div.innerHTML = `
                        <div>
                            <strong>${trans.source}</strong><br>
                            <small>${formatDate(trans.date)}</small>
                        </div>
                        <div class="trans-amount income">
                            + ${formatCurrency(trans.amount)}
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <div>
                            <strong>${trans.category}</strong><br>
                            <small>${formatDate(trans.date)}</small>
                        </div>
                        <div class="trans-amount expense">
                            - ${formatCurrency(trans.amount)}
                        </div>
                    `;
                }
                
                container.appendChild(div);
            });
        }
        
        // Update report page
        function updateReportPage() {
            // Update year select
            updateYearSelect();
        }
        
        // Update settings page
        function updateSettingsPage() {
            document.getElementById('currentYear').textContent = businessData.currentYear;
            document.getElementById('totalModalCount').textContent = businessData.modal.length + ' transaksi';
            document.getElementById('totalExpenseCount').textContent = businessData.expenses.length + ' transaksi';
            document.getElementById('totalIncomeCount').textContent = businessData.incomes.length + ' transaksi';
        }
        
        // Update year select
        function updateYearSelect() {
            const yearSelect = document.getElementById('reportYear');
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === businessData.currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }
        
        // Generate PDF report
        async function generatePDFReport(year, month) {
            showLoading();
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const monthName = monthNames[month];
                const pageWidth = doc.internal.pageSize.getWidth();
                
                // Header
                doc.setFontSize(20);
                doc.setTextColor(45, 106, 79);
                doc.text('FlexiBudget - Laporan Usaha', pageWidth / 2, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text(`Bulan: ${monthName} ${year}`, pageWidth / 2, 30, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`Dibuat: ${new Date().toLocaleDateString('id-ID')}`, pageWidth / 2, 37, { align: 'center' });
                
                // Summary
                doc.setFontSize(12);
                doc.setTextColor(45, 106, 79);
                doc.text('Ringkasan Keuangan', 14, 50);
                
                doc.setDrawColor(45, 106, 79);
                doc.setLineWidth(0.5);
                doc.line(14, 52, pageWidth - 14, 52);
                
                // Calculate data for selected month
                const modalThisMonth = businessData.modal.filter(m => {
                    const date = new Date(m.date);
                    return date.getFullYear() === year && date.getMonth() === month;
                });
                
                const expensesThisMonth = businessData.expenses.filter(e => {
                    const date = new Date(e.date);
                    return date.getFullYear() === year && date.getMonth() === month;
                });
                
                const incomesThisMonth = businessData.incomes.filter(i => {
                    const date = new Date(i.date);
                    return date.getFullYear() === year && date.getMonth() === month;
                });
                
                const totalModal = modalThisMonth.reduce((sum, m) => sum + m.amount, 0);
                const totalExpense = expensesThisMonth.reduce((sum, e) => sum + e.amount, 0);
                const totalIncome = incomesThisMonth.reduce((sum, i) => sum + i.amount, 0);
                const finalBalance = (totalModal + totalIncome) - totalExpense;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Total Modal: ${formatCurrency(totalModal)}`, 20, 60);
                doc.text(`Total Pemasukan: ${formatCurrency(totalIncome)}`, 20, 67);
                doc.text(`Total Pengeluaran: ${formatCurrency(totalExpense)}`, 20, 74);
                doc.text(`Saldo Akhir: ${formatCurrency(finalBalance)}`, 20, 81);
                
                // Modal Table
                let yPos = 90;
                doc.setFontSize(12);
                doc.setTextColor(45, 106, 79);
                doc.text('Detail Modal', 14, yPos);
                doc.setDrawColor(45, 106, 79);
                doc.line(14, yPos + 2, pageWidth - 14, yPos + 2);
                
                yPos += 10;
                
                const modalData = modalThisMonth.map(m => [
                    formatDate(m.date),
                    m.description || '-',
                    formatCurrency(m.amount)
                ]);
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Tanggal', 'Keterangan', 'Jumlah']],
                    body: modalData,
                    theme: 'striped',
                    headStyles: { fillColor: [45, 106, 79] },
                    margin: { left: 14, right: 14 }
                });
                
                // Income Table
                yPos = doc.lastAutoTable.finalY + 15;
                doc.setFontSize(12);
                doc.setTextColor(45, 106, 79);
                doc.text('Detail Pemasukan', 14, yPos);
                doc.setDrawColor(45, 106, 79);
                doc.line(14, yPos + 2, pageWidth - 14, yPos + 2);
                
                yPos += 10;
                
                const incomeData = incomesThisMonth.map(i => [
                    formatDate(i.date),
                    i.source,
                    i.description || '-',
                    formatCurrency(i.amount)
                ]);
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Tanggal', 'Sumber', 'Keterangan', 'Jumlah']],
                    body: incomeData,
                    theme: 'striped',
                    headStyles: { fillColor: [45, 106, 79] },
                    margin: { left: 14, right: 14 }
                });
                
                // Expense Table
                yPos = doc.lastAutoTable.finalY + 15;
                doc.setFontSize(12);
                doc.setTextColor(45, 106, 79);
                doc.text('Detail Pengeluaran', 14, yPos);
                doc.setDrawColor(45, 106, 79);
                doc.line(14, yPos + 2, pageWidth - 14, yPos + 2);
                
                yPos += 10;
                
                const expenseData = expensesThisMonth.map(e => [
                    formatDate(e.date),
                    e.category,
                    e.description || '-',
                    formatCurrency(e.amount)
                ]);
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Tanggal', 'Kategori', 'Keterangan', 'Jumlah']],
                    body: expenseData,
                    theme: 'striped',
                    headStyles: { fillColor: [45, 106, 79] },
                    margin: { left: 14, right: 14 }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`Halaman ${i} dari ${pageCount}`, pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                }
                
                // Save PDF
                doc.save(`Laporan_Usaha_${monthName}_${year}.pdf`);
                showToast('Laporan berhasil diunduh!');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('Error membuat laporan PDF');
            } finally {
                hideLoading();
            }
        }
        
        // Delete modal
        window.deleteModal = function(index) {
            const modal = getCurrentMonthModal()[index];
            if (!modal) return;
            
            if (confirm(`Hapus modal "${modal.description}" senilai ${formatCurrency(modal.amount)}?`)) {
                // Find actual index in businessData.modal
                const actualIndex = businessData.modal.findIndex(m => 
                    m.date === modal.date && 
                    m.amount === modal.amount && 
                    m.description === modal.description
                );
                
                if (actualIndex !== -1) {
                    businessData.modal.splice(actualIndex, 1);
                    saveData();
                    showToast('Modal berhasil dihapus');
                }
            }
        };
        
        // ========== EVENT HANDLERS ==========
        
        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active from all
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('active');
                });
                document.querySelectorAll('.page').forEach(p => {
                    p.classList.remove('active');
                });
                
                // Add active to clicked
                this.classList.add('active');
                const pageId = this.getAttribute('data-page');
                document.getElementById(pageId).classList.add('active');
            });
        });
        
        // Month navigation for Dashboard page
        document.getElementById('prevMonthBtnDashboard').addEventListener('click', function() {
            businessData.currentMonth--;
            if (businessData.currentMonth < 0) {
                businessData.currentMonth = 11;
                businessData.currentYear--;
            }
            saveData();
        });
        
        document.getElementById('nextMonthBtnDashboard').addEventListener('click', function() {
            businessData.currentMonth++;
            if (businessData.currentMonth > 11) {
                businessData.currentMonth = 0;
                businessData.currentYear++;
            }
            saveData();
        });
        
        // Month navigation for Modal page
        document.getElementById('prevMonthBtnModal').addEventListener('click', function() {
            businessData.currentMonth--;
            if (businessData.currentMonth < 0) {
                businessData.currentMonth = 11;
                businessData.currentYear--;
            }
            saveData();
        });
        
        document.getElementById('nextMonthBtnModal').addEventListener('click', function() {
            businessData.currentMonth++;
            if (businessData.currentMonth > 11) {
                businessData.currentMonth = 0;
                businessData.currentYear++;
            }
            saveData();
        });
        
        // Month navigation for Expense page
        document.getElementById('prevMonthBtnExpense').addEventListener('click', function() {
            businessData.currentMonth--;
            if (businessData.currentMonth < 0) {
                businessData.currentMonth = 11;
                businessData.currentYear--;
            }
            saveData();
        });
        
        document.getElementById('nextMonthBtnExpense').addEventListener('click', function() {
            businessData.currentMonth++;
            if (businessData.currentMonth > 11) {
                businessData.currentMonth = 0;
                businessData.currentYear++;
            }
            saveData();
        });
        
        // Month navigation for Income page
        document.getElementById('prevMonthBtnIncome').addEventListener('click', function() {
            businessData.currentMonth--;
            if (businessData.currentMonth < 0) {
                businessData.currentMonth = 11;
                businessData.currentYear--;
            }
            saveData();
        });
        
        document.getElementById('nextMonthBtnIncome').addEventListener('click', function() {
            businessData.currentMonth++;
            if (businessData.currentMonth > 11) {
                businessData.currentMonth = 0;
                businessData.currentYear++;
            }
            saveData();
        });
        
        // Month navigation for Balance page
        document.getElementById('prevMonthBtnBalance').addEventListener('click', function() {
            businessData.currentMonth--;
            if (businessData.currentMonth < 0) {
                businessData.currentMonth = 11;
                businessData.currentYear--;
            }
            saveData();
        });
        
        document.getElementById('nextMonthBtnBalance').addEventListener('click', function() {
            businessData.currentMonth++;
            if (businessData.currentMonth > 11) {
                businessData.currentMonth = 0;
                businessData.currentYear++;
            }
            saveData();
        });
        
        // Save modal
        document.getElementById('simpanModalBtn').addEventListener('click', function() {
            const amount = parseInt(document.getElementById('modalAmount').value);
            const description = document.getElementById('modalDesc').value.trim();
            
            if (!description) {
                alert('Masukkan keterangan modal!');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Jumlah modal harus lebih dari 0!');
                return;
            }
            
            const today = new Date();
            const modal = {
                id: 'modal_' + Date.now(),
                amount: amount,
                description: description,
                date: today.toISOString().split('T')[0]
            };
            
            businessData.modal.push(modal);
            saveData();
            
            // Reset form
            document.getElementById('modalAmount').value = '';
            document.getElementById('modalDesc').value = '';
            
            showToast('Modal berhasil disimpan!');
        });
        
        // Save expense
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = parseInt(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDesc').value.trim();
            const expenseDate = document.getElementById('expenseDate').value;
            
            if (!category) {
                alert('Pilih kategori pengeluaran!');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Jumlah pengeluaran harus lebih dari 0!');
                return;
            }
            
            // Check modal balance
            const modalTotals = calculateModalTotals();
            if (modalTotals.sisaModal < amount) {
                if (!confirm(`Peringatan: Pengeluaran ini melebihi sisa modal!\nSisa modal: ${formatCurrency(modalTotals.sisaModal)}\nPengeluaran: ${formatCurrency(amount)}\nLanjutkan?`)) {
                    return;
                }
            }
            
            const expense = {
                id: 'expense_' + Date.now(),
                amount: amount,
                category: category,
                description: description,
                date: expenseDate
            };
            
            businessData.expenses.push(expense);
            saveData();
            
            // Reset form
            this.reset();
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = todayStr;
            
            showToast('Pengeluaran berhasil disimpan!');
        });
        
        // Save income
        document.getElementById('incomeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = parseInt(document.getElementById('incomeAmount').value);
            const source = document.getElementById('incomeSource').value;
            const description = document.getElementById('incomeDesc').value.trim();
            const incomeDate = document.getElementById('incomeDate').value;
            
            if (!source) {
                alert('Pilih sumber pemasukan!');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Jumlah pemasukan harus lebih dari 0!');
                return;
            }
            
            const income = {
                id: 'income_' + Date.now(),
                amount: amount,
                source: source,
                description: description,
                date: incomeDate
            };
            
            businessData.incomes.push(income);
            saveData();
            
            // Reset form
            this.reset();
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('incomeDate').value = todayStr;
            
            showToast('Pemasukan berhasil disimpan!');
        });
        
        // Export monthly report
        document.getElementById('exportMonthlyBtn').addEventListener('click', function() {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            generatePDFReport(year, month);
        });
        
        // Backup data
        document.getElementById('backupBtn').addEventListener('click', function() {
            const dataStr = JSON.stringify(businessData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `flexibudget_usaha_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('Data usaha berhasil di-backup!');
        });
        
        // Restore data
        document.getElementById('restoreBtn').addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const backup = JSON.parse(e.target.result);
                        if (confirm('Restore data usaha? Data saat ini akan diganti.')) {
                            businessData = backup;
                            saveData();
                            showToast('Data usaha berhasil di-restore!');
                        }
                    } catch (err) {
                        alert('File backup tidak valid!');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        });
        
        // Reset data
        document.getElementById('resetBtn').addEventListener('click', function() {
            if (confirm('RESET SEMUA DATA USAHA?\nIni akan menghapus semua data modal, pengeluaran, dan pemasukan!')) {
                if (prompt('Ketik "RESET" untuk konfirmasi:') === 'RESET') {
                    localStorage.removeItem('flexibudget_business');
                    location.reload();
                }
            }
        });
        
        // ========== UTILITY FUNCTIONS ==========
        
        function formatCurrency(amount) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                amount = 0;
            }
            return 'Rp ' + Math.round(amount).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
        
        // ========== INITIALIZE ==========
        
        function initApp() {
            loadData();
            
            // Set default dates
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            document.getElementById('expenseDate').value = todayStr;
            document.getElementById('incomeDate').value = todayStr;
            
            // Initialize month selector
            document.getElementById('reportMonth').value = today.getMonth();
            updateYearSelect();
            
            // Set default date in modal form
            document.getElementById('modalAmount').value = '';
            document.getElementById('modalDesc').value = '';
            
            // Populate category select
            const categorySelect = document.getElementById('expenseCategory');
            businessData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            // Populate income source select
            const sourceSelect = document.getElementById('incomeSource');
            businessData.incomeSources.forEach(source => {
                const option = document.createElement('option');
                option.value = source;
                option.textContent = source;
                sourceSelect.appendChild(option);
            });
            
            console.log('Aplikasi FlexiBudget Usaha siap!');
            console.log('Versi:', businessData.version);
            console.log('Modal:', businessData.modal.length);
            console.log('Pengeluaran:', businessData.expenses.length);
            console.log('Pemasukan:', businessData.incomes.length);
            console.log('Bulan:', monthNames[businessData.currentMonth], businessData.currentYear);
        }
        
        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>